<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forecasting 2.0 Demo</title>
    <script>
      // Bump this on each deploy to bust caches
      window.APP_VERSION = '2025.09.30.44';
      (function(){
        // Force-bust HTML once per deploy by appending ?v=APP_VERSION
        try {
          var v = window.APP_VERSION;
          var sp = new URLSearchParams(location.search);
          if (sp.get('v') !== v) {
            sp.set('v', v);
            location.replace(location.pathname + '?' + sp.toString());
            return; // abort further execution; page will reload
          }
        } catch(_) {}
        function addVersion(url){
          try {
            var u = new URL(url, location.href);
            if (u.origin !== location.origin) return url; // only local assets
            u.searchParams.set('v', window.APP_VERSION);
            return u.pathname + '?' + u.searchParams.toString();
          } catch (_) { return url; }
        }
        document.addEventListener('DOMContentLoaded', function(){
          document.querySelectorAll('link[rel="stylesheet"][href]').forEach(function(el){ el.href = addVersion(el.getAttribute('href')); });
          document.querySelectorAll('script[src]').forEach(function(el){ el.src = addVersion(el.getAttribute('src')); });
          document.querySelectorAll('img[src]').forEach(function(el){ el.src = addVersion(el.getAttribute('src')); });
        });
      })();
    </script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://unpkg.com/recharts@2.8.0/umd/Recharts.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@radix-ui/colors@latest/styles.css?v=" id="radix-css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Roboto+Mono:wght@400;500&display=swap');
        
        /* Enterprise tokens embedded directly to avoid caching issues */
        :root {
          /* Enterprise brand + surface tokens */
          --brand-600: #0F62FE; /* IBM-ish primary */
          --brand-700: #0B4ACB;
          --accent-amber-600: #D97706; /* stronger orange */
          --accent-amber-700: #B45309;
          --surface: #FFFFFF;
          --surface-muted: #F2F4F8; /* visibly different from existing */
          --border: #A8B3C2; /* stronger border token */
          --text-primary: #111827;
          --text-secondary: #475569;
          --radius-lg: 12px;
        }

        /* Make KPI cards visibly different sitewide */
        .kpi-card {
          background: var(--surface-muted) !important;
          border-color: var(--border) !important;
        }

        /* Buttons use enterprise brand */
        .btn-primary {
          background: var(--brand-600) !important;
        }
        .btn-primary:hover {
          background: var(--brand-700) !important;
        }

        /* General card border strength */
        .card {
          border-color: var(--border) !important;
        }

        /* Elevate subtle action buttons */
        .btn-secondary {
          background: #fff !important;
          border: 1px solid var(--border) !important;
          color: #1f2937 !important; /* gray-800 */
        }
        .btn-secondary:hover {
          background: #f8fafc !important;
        }
        
        /* Dark theme */
        [data-theme='dark']{
          --surface:#0B1220; --surface-muted:#0F172A; --border:#243244;
          --text-primary:#E5E7EB; --text-secondary:#94A3B8;
          --brand-600:#1E40AF; --brand-700:#1E3A8A;
        }
        [data-theme='dark'] body{ background:var(--surface-muted)!important; color:var(--text-primary)!important; }
        [data-theme='dark'] .card,[data-theme='dark'] .kpi-card,[data-theme='dark'] .btn-secondary{
          background:var(--surface)!important; border-color:var(--border)!important; color:var(--text-primary)!important;
        }
        
        /* Dark: utility overrides so Tailwind classes flip */
        [data-theme='dark'] .bg-gray-50 { background-color: var(--surface-muted) !important; }
        [data-theme='dark'] .bg-white   { background-color: var(--surface) !important; }
        [data-theme='dark'] .border-gray-200 { border-color: var(--border) !important; }

        /* Comprehensive text color overrides for dark mode */
        [data-theme='dark'] .text-gray-900 { color: var(--text-primary) !important; }
        [data-theme='dark'] .text-gray-800 { color: var(--text-primary) !important; }
        [data-theme='dark'] .text-gray-700 { color: var(--text-primary) !important; }
        [data-theme='dark'] .text-gray-600 { color: var(--text-secondary) !important; }
        [data-theme='dark'] .text-gray-500 { color: var(--text-secondary) !important; }
        [data-theme='dark'] .text-gray-400 { color: var(--text-secondary) !important; }

        /* Hover state text color overrides */
        [data-theme='dark'] .hover\:text-gray-700:hover { color: var(--text-primary) !important; }
        [data-theme='dark'] .hover\:text-gray-800:hover { color: var(--text-primary) !important; }

        /* Left nav active pill ("Forecasting") in dark mode */
        [data-theme='dark'] .bg-blue-50 { background-color: rgba(37, 99, 235, 0.26) !important; }
        [data-theme='dark'] .text-blue-600 { color: #60A5FA !important; }

        /* Chip groups (scope/subcategory filters) */
        [data-theme='dark'] .bg-gray-100 { background-color: rgba(148, 163, 184, 0.12) !important; }
        [data-theme='dark'] .text-gray-700 { color: var(--text-primary) !important; }
        [data-theme='dark'] .border { border-color: var(--border) !important; }

        /* Data table row hover/highlight */
        [data-theme='dark'] .hover\:bg-gray-50:hover { background-color: var(--surface-muted) !important; }
        [data-theme='dark'] .divide-gray-200 > :not([hidden]) ~ :not([hidden]) { border-color: var(--border) !important; }

        /* Badges/pills */
        [data-theme='dark'] .badge, [data-theme='dark'] .badge-muted { background-color: rgba(148,163,184,0.12) !important; color: var(--text-secondary) !important; }

        /* Cards inside dark sections */
        [data-theme='dark'] .card > .bg-white { background-color: var(--surface) !important; }
        
        /* NUCLEAR APPROACH: Override ALL possible text color combinations */
        [data-theme='dark'] * { color: var(--text-primary) !important; }
        [data-theme='dark'] .text-yellow-500,
        [data-theme='dark'] .text-amber-600 { color: inherit !important; }
        
        /* Preserve specific colored elements */
        [data-theme='dark'] .text-positive { color: #10B981 !important; }
        [data-theme='dark'] .text-negative { color: #EF4444 !important; }
        [data-theme='dark'] .text-blue-600 { color: #60A5FA !important; }
        
        /* Preserve Above/Below Average badge colors */
        [data-theme='dark'] .text-green-600 { color: #10B981 !important; }
        [data-theme='dark'] .text-red-600 { color: #EF4444 !important; }
        
        /* Fix dropdown and form elements in dark mode */
        [data-theme='dark'] .input,
        [data-theme='dark'] select.input { 
            background-color: var(--surface) !important; 
            border-color: var(--border) !important; 
            color: var(--text-primary) !important; 
        }
        
        /* Ensure checkboxes are visible in dark mode */
        [data-theme='dark'] input[type="checkbox"] {
            appearance: auto !important;
            -webkit-appearance: checkbox !important;
            opacity: 1 !important;
            position: relative !important;
            width: 1rem !important;
            height: 1rem !important;
            cursor: pointer !important;
            accent-color: #60A5FA !important;
        }
        
        /* Fix confidence badges - preserve colored backgrounds with proper contrast */
        [data-theme='dark'] .bg-green-50 { background-color: rgba(16, 185, 129, 0.15) !important; }
        [data-theme='dark'] .text-green-700 { color: #10B981 !important; }
        [data-theme='dark'] .border-green-200 { border-color: rgba(16, 185, 129, 0.3) !important; }
        
        [data-theme='dark'] .bg-amber-50 { background-color: rgba(245, 158, 11, 0.15) !important; }
        [data-theme='dark'] .text-amber-700 { color: #F59E0B !important; }
        [data-theme='dark'] .border-amber-200 { border-color: rgba(245, 158, 11, 0.3) !important; }
        
        [data-theme='dark'] .bg-red-50 { background-color: rgba(239, 68, 68, 0.15) !important; }
        [data-theme='dark'] .text-red-700 { color: #EF4444 !important; }
        [data-theme='dark'] .border-red-200 { border-color: rgba(239, 68, 68, 0.3) !important; }
        
        /* Fix Recharts tooltips in dark mode */
        [data-theme='dark'] .recharts-tooltip-wrapper .recharts-default-tooltip {
            background-color: var(--surface) !important;
            border: 1px solid var(--border) !important;
            border-radius: 8px !important;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3) !important;
        }
        [data-theme='dark'] .recharts-tooltip-wrapper .recharts-default-tooltip .recharts-tooltip-label {
            color: var(--text-primary) !important;
        }
        [data-theme='dark'] .recharts-tooltip-wrapper .recharts-default-tooltip .recharts-tooltip-item {
            color: var(--text-primary) !important;
        }
        [data-theme='dark'] .recharts-tooltip-wrapper .recharts-default-tooltip .recharts-tooltip-item-list {
            color: var(--text-primary) !important;
        }
        
        /* ULTRA NUCLEAR: Override EVERYTHING white in dark mode */
        [data-theme='dark'] .bg-white,
        [data-theme='dark'] div[style*="background"],
        [data-theme='dark'] svg,
        [data-theme='dark'] .recharts-wrapper,
        [data-theme='dark'] .recharts-surface,
        [data-theme='dark'] .recharts-cartesian-grid,
        [data-theme='dark'] .recharts-responsive-container {
            background-color: var(--surface) !important;
            background: var(--surface) !important;
        }
        
        /* Force all SVG backgrounds to be dark */
        [data-theme='dark'] svg rect[fill="white"],
        [data-theme='dark'] svg rect[fill="#ffffff"],
        [data-theme='dark'] svg rect[fill="#FFFFFF"] {
            fill: var(--surface) !important;
        }
        /* Recommended Action label color */
        .ra-label { color: var(--accent-amber-700); }
        [data-theme='dark'] .ra-label { color: var(--accent-amber-700) !important; }

        /* Nuclear override: ensure highlight and KPI borders/background win in dark mode */
        [data-theme='dark'] .card_highlight {
            background-color: #111a2a !important;
            border: 2px solid rgba(96,165,250,0.60) !important;
            box-shadow: 0 0 0 1px rgba(96,165,250,0.45) !important;
        }
        /* Specific container override per request */
        [data-theme='dark'] #sku-action-wrap {
            background-color: #28324E !important;
            border: 2px solid rgba(96,165,250,0.60) !important;
            box-shadow: 0 0 0 1px rgba(96,165,250,0.45) !important;
        }
        /* KPI cards: requested fill color */
        [data-theme='dark'] .kpi-card { background-color: #28324E !important; }
        /* Subtle risk borders only */
        /* Reusable subtle border tints */
        [data-theme='dark'] .border-tint-red { border-color: #ef4444 !important; border-width: 2px !important; border-style: solid !important; }
        [data-theme='dark'] .border-tint-green { border-color: #10b981 !important; border-width: 2px !important; border-style: solid !important; }
        /* (reverted) risk coloring */
        
        body {
            font-family: 'Inter', sans-serif;
            background: #f2f4f7; /* more enterprise, higher contrast */
            color: #111111;
            min-height: 100vh;
        }
        
        /* Professional hover effects */
        .card-hover {
            transition: all 0.2s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .kpi-card {
            background: #f8fafc; /* visibly muted surface */
            border: 2px solid var(--border);
            transition: all 0.2s ease;
        }
        
        .kpi-card:hover {
            border-color: #1E4DD8;
            box-shadow: 0 0 0 1px rgba(30, 77, 216, 0.1);
        }
        
        .role-btn {
            transition: all 0.15s ease;
        }
        
        .role-btn:hover {
            background-color: #f3f4f6;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-high { background-color: #6b7280; }
        .status-medium { background-color: #9ca3af; }
        .status-low { background-color: #374151; }
        
        .text-positive { color: #111111; }
        .text-negative { color: #374151; }
        .text-warning { color: #6b7280; }
        
        .bg-positive { background-color: #f9fafb; }
        .bg-negative { background-color: #f3f4f6; }
        .bg-warning { background-color: #f9fafb; }
        
        .font-mono {
            font-family: 'Roboto Mono', monospace;
        }
    </style>
    <style>
        /* Enterprise tokens are defined in tokens.css */

        /* Focus policy */
        :focus-visible {
            outline: 2px solid var(--brand-600);
            outline-offset: 2px;
            border-radius: var(--radius-sm);
        }
    </style>

    <style type="text/tailwindcss">
        @layer components {
            .btn { @apply inline-flex items-center justify-center gap-2 px-3.5 py-2.5 text-sm font-medium rounded-md transition-colors; }
            .btn-primary { background: var(--brand-600); color: #fff; }
            .btn-primary:hover { background: var(--brand-700); }
            .btn-secondary { @apply bg-white border text-gray-700; border-color: var(--border); }
            .btn-secondary:hover { background: #f8fafc; }

            .card { @apply bg-white border; border-color: var(--border); box-shadow: var(--shadow-card); border-radius: var(--radius-lg); border-width: 2px; }
            .input { @apply w-full px-3 py-2 text-sm border rounded-md; border-color: var(--border); }
            .badge { @apply inline-flex items-center px-2 py-0.5 text-xs font-medium rounded-md; }
            .badge-muted { @apply bg-gray-100 text-gray-700; }

            /* Reuse for existing tiles */
            .kpi-card { border-radius: var(--radius-lg, 12px); }
        }
    </style>
    <script>document.documentElement.setAttribute('data-theme','dark');</script>
</head>
<body>
    <div id="app" class="flex h-screen bg-gray-50">
        <!-- Left Navigation Panel -->
        <div class="w-64 bg-white border-r border-gray-200 flex flex-col">
            <!-- Brand/Logo -->
            <div class="border-b border-gray-200 p-0">
                <a class="block cursor-pointer" onclick="goToHomepage()" aria-label="Go to homepage">
                    <img src="assets/brand/logo-header.png" alt="Invisible NEURON" class="w-full h-auto block" onerror="this.parentElement.querySelector('[data-fallback]').classList.remove('hidden'); this.classList.add('hidden');">
                    <div data-fallback class="hidden p-4">
                        <h1 class="text-lg font-bold text-gray-900">Invisible</h1>
                        <p class="text-sm text-gray-500">NEURON</p>
                    </div>
                </a>
            </div>

            <!-- Group Identifier -->
            <div class="px-6 py-3 border-b border-gray-200">
                <p class="text-sm font-medium text-gray-700">Group III</p>
            </div>

            <!-- Navigation Menu -->
            <nav class="flex-1 p-4 space-y-2">
                <a href="#" class="flex items-center space-x-3 px-3 py-2 text-sm text-gray-600 rounded-md hover:bg-gray-50">
                    <i data-lucide="clock" class="w-4 h-4"></i>
                    <span>Pipeline Status</span>
                </a>
                <a href="#" class="flex items-center space-x-3 px-3 py-2 text-sm text-gray-600 rounded-md hover:bg-gray-50">
                    <i data-lucide="settings" class="w-4 h-4"></i>
                    <span>Data Quality</span>
                </a>
                <a href="#" class="flex items-center space-x-3 px-3 py-2 text-sm text-gray-600 rounded-md hover:bg-gray-50">
                    <i data-lucide="network" class="w-4 h-4"></i>
                    <span>Data Ontology</span>
                </a>
                <a href="#" onclick="goToHomepage(); return false;" class="flex items-center space-x-3 px-3 py-2 text-sm font-medium text-blue-600 bg-blue-50 rounded-md">
                    <i data-lucide="trending-up" class="w-4 h-4"></i>
                    <span>Forecasting</span>
                </a>
            </nav>

            <!-- Bottom Section -->
            <div class="p-4 border-t border-gray-200">
                <a href="#" class="flex items-center space-x-2 text-sm text-gray-500 hover:text-gray-700 mb-4">
                    <i data-lucide="chevron-left" class="w-4 h-4"></i>
                    <span>Collapse Navigation</span>
                </a>
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center">
                        <i data-lucide="user" class="w-4 h-4 text-gray-600"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-900">Tony</p>
                        <p class="text-xs text-gray-500">tony@alpha.com</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Top Header -->
            <header class="text-gray-900 bg-white border-b border-gray-200 px-6 py-3">
                <div class="flex items-start justify-between mb-4">
                    <!-- Page Title -->
                    <div>
                        <h1 class="text-2xl md:text-3xl font-semibold text-gray-900">Forecasting</h1>
                        <p class="text-sm md:text-base text-gray-500">Predict future demand with confidence to empower accurate and agile demand planning.</p>
                    </div>
                    
                    <!-- Tour Button -->
                    <button id="global-tour-btn" class="btn btn-secondary flex items-center gap-2" onclick="startTour()">
                        <i data-lucide="help-circle" class="w-4 h-4"></i>
                        Take a Tour
                    </button>
                </div>
                
                <!-- Breadcrumbs -->
                <nav aria-label="Breadcrumb" class="flex items-center space-x-2 text-sm text-gray-600" id="breadcrumbs">
                    <span class="cursor-pointer text-blue-600 hover:underline" onclick="goToPortfolio()">Overview</span>
                </nav>
            </header>

            <!-- Main Content -->
            <main class="flex-1 overflow-auto p-6">
            <!-- Hero Section intentionally left empty -->

            <!-- Hero KPIs -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="kpi-card card-hover card p-6 cursor-pointer" onclick="drillDown('portfolio')">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500 mb-1">Total Revenue</p>
                            <p class="text-2xl font-semibold text-gray-900">$2.4M</p>
                            <p class="text-sm text-gray-500 mt-1">Last 24 months</p>
                        </div>
                        <div>
                            <span class="text-sm font-medium text-green-600">+12.3%</span>
                        </div>
                    </div>
                </div>

                <div class="kpi-card card-hover card p-6 cursor-pointer" onclick="showCategories()">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500 mb-1">Forecast Revenue</p>
                            <p class="text-2xl font-semibold text-gray-900">$2.7M</p>
                            <p class="text-sm text-gray-500 mt-1">Next 3 months</p>
                        </div>
                        <div>
                            <span class="text-sm font-medium text-green-600">+12.3%</span>
                        </div>
                    </div>
                </div>

                <div class="kpi-card card-hover card p-6 cursor-pointer" onclick="showCategories()">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500 mb-1">Miss Rate</p>
                            <p class="text-2xl font-semibold text-gray-900">8.2%</p>
                            <p class="text-sm text-gray-500 mt-1">Model vs Baseline</p>
                        </div>
                        <div>
                            <span class="text-sm font-medium text-red-600">-5.2%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Role-specific KPIs -->
            <div id="role-specific-kpis" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <!-- Ops KPIs -->
                <div class="card p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500 mb-1">Inventory Risk</p>
                            <p class="text-2xl font-semibold text-gray-900">Medium</p>
                            <p class="text-sm text-gray-500 mt-1">3 categories at risk</p>
                        </div>
                        <div class="text-blue-600">
                            <i data-lucide="package" class="w-6 h-6"></i>
                        </div>
                    </div>
                </div>

                <!-- Subcategory filter (visible when a category is selected) -->
                <div id="subcategory-filter" class="mb-4"></div>

                <div class="card p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500 mb-1">Stockout Risk</p>
                            <p class="text-2xl font-semibold text-gray-900">Low</p>
                            <p class="text-sm text-gray-500 mt-1">2 SKUs flagged</p>
                        </div>
                        <div class="text-blue-600">
                            <i data-lucide="alert-triangle" class="w-6 h-6"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Chart -->
            <div class="card p-6 mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Revenue Forecast vs Actuals</h3>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-blue-600 rounded-full"></div>
                            <span class="text-sm text-gray-500">Model Forecast</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-gray-400 rounded-full"></div>
                            <span class="text-sm text-gray-500">Baseline</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-green-600 rounded-full"></div>
                            <span class="text-sm text-gray-500">Actual</span>
                        </div>
                    </div>
                </div>
                <div class="h-80 bg-white rounded-lg">
                    <div id="portfolio-chart" class="w-full h-full"></div>
                </div>
            </div>

            <!-- Insights + Nav Row -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8">
                <!-- Top Insights (left) -->
                <div class="card p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Top Insights</h3>
                    <div class="space-y-3">
                        <div class="flex items-start space-x-3">
                            <div class="w-2 h-2 bg-green-600 rounded-full mt-2"></div>
                            <div>
                                <p class="text-sm font-medium text-gray-900">Electronics category up 22%</p>
                                <p class="text-xs text-gray-500">Supply down. Reorder now.</p>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3">
                            <div class="w-2 h-2 bg-yellow-500 rounded-full mt-2"></div>
                            <div>
                                <p class="text-sm font-medium text-gray-900">Clothing confidence low</p>
                                <p class="text-xs text-gray-500">Sparse history. Investigate.</p>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3">
                            <div class="w-2 h-2 bg-red-600 rounded-full mt-2"></div>
                            <div>
                                <p class="text-sm font-medium text-gray-900">Toys & Games forecast down 15%</p>
                                <p class="text-xs text-gray-500">Weeks of supply >8. Markdown recommended.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- View Categories (middle) -->
                <div class="card p-6">
                    <div class="flex items-center space-x-3 mb-2">
                        <i data-lucide="bar-chart-3" class="w-5 h-5 text-blue-600"></i>
                        <h4 class="font-semibold text-gray-900">View Categories</h4>
                    </div>
                    <ul class="text-sm space-y-2">
                        <li><a href="#" onclick="chooseCategory('electronics'); return false;" class="text-blue-600 hover:underline">Electronics</a></li>
                        <li><a href="#" onclick="chooseCategory('clothing'); return false;" class="text-blue-600 hover:underline">Clothing</a></li>
                        <li><a href="#" onclick="chooseCategory('toys'); return false;" class="text-blue-600 hover:underline">Toys & Games</a></li>
                    </ul>
                </div>
                <!-- View Misses (right) -->
                <div class="card p-6">
                    <div class="flex items-center space-x-3 mb-2">
                        <i data-lucide="alert-triangle" class="w-5 h-5 text-yellow-500"></i>
                        <h4 class="font-semibold text-gray-900">View Misses</h4>
                    </div>
                    <ul class="text-sm space-y-2">
                        <li><span>High miss:</span> <span class="text-blue-600 hover:underline cursor-pointer">Electronics − Baseline MAPE 24%</span></li>
                        <li><span>Low confidence:</span> <span class="text-blue-600 hover:underline cursor-pointer">Clothing − Investigate sparse history</span></li>
                        <li><span>Overstock:</span> <span class="text-blue-600 hover:underline cursor-pointer">Toys & Games − WOS > 8, apply markdown</span></li>
                    </ul>
                </div>
            </div>

            
            </main>
        </div>
    </div>

    <!-- V1 View (Hidden by default) -->
    <div id="v1-view" class="hidden flex h-screen bg-gray-50">
        <!-- Left Navigation Panel (Same as V2) -->
        <div class="w-64 bg-white border-r border-gray-200 flex flex-col">
            <!-- Brand/Logo -->
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center space-x-3 cursor-pointer hover:bg-gray-50 rounded-lg p-2 -m-2" onclick="goToHomepage()">
                    <div class="w-8 h-8 bg-gradient-to-r from-purple-600 to-pink-600 rounded-lg flex items-center justify-center">
                        <i data-lucide="zap" class="w-5 h-5 text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-gray-900">Invisible</h1>
                        <p class="text-sm text-gray-500">NEURON</p>
                    </div>
                </div>
            </div>

            <!-- Group Identifier -->
            <div class="px-6 py-3 border-b border-gray-200">
                <p class="text-sm font-medium text-gray-700">Group III</p>
            </div>

            <!-- Navigation Menu -->
            <nav class="flex-1 p-4 space-y-2">
                <a href="#" class="flex items-center space-x-3 px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-md">
                    <i data-lucide="clock" class="w-4 h-4"></i>
                    <span>Pipeline Status</span>
                </a>
                <a href="#" class="flex items-center space-x-3 px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-md">
                    <i data-lucide="settings" class="w-4 h-4"></i>
                    <span>Data Quality</span>
                </a>
                <a href="#" class="flex items-center space-x-3 px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-md">
                    <i data-lucide="network" class="w-4 h-4"></i>
                    <span>Data Ontology</span>
                </a>
                <a href="#" class="flex items-center space-x-3 px-3 py-2 text-sm font-medium text-blue-600 bg-blue-50 rounded-md">
                    <i data-lucide="trending-up" class="w-4 h-4"></i>
                    <span>Forecasting</span>
                </a>
            </nav>

            <!-- Bottom Section -->
            <div class="p-4 border-t border-gray-200">
                <a href="#" class="flex items-center space-x-2 text-sm text-gray-500 hover:text-gray-700 mb-4">
                    <i data-lucide="chevron-left" class="w-4 h-4"></i>
                    <span>Collapse Navigation</span>
                </a>
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center">
                        <i data-lucide="user" class="w-4 h-4 text-gray-600"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-900">Tony</p>
                        <p class="text-xs text-gray-500">tony@alpha.com</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Top Header -->
            <header class="bg-white border-b border-gray-200 px-6 py-4">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-2xl font-semibold text-gray-900">Forecasting 1.0</h1>
                        <p class="text-sm text-gray-500">Legacy forecasting interface</p>
                    </div>
                </div>
            </header>
            
            <!-- V1 Content -->
            <main class="flex-1 overflow-auto p-6">
                <div class="bg-white rounded-lg border border-gray-200 p-8 shadow-sm">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-gray-100 rounded-lg mx-auto mb-4 flex items-center justify-center">
                            <i data-lucide="bar-chart-3" class="w-8 h-8 text-gray-400"></i>
                        </div>
                        <h2 class="text-xl font-semibold text-gray-900 mb-2">V1 View Placeholder</h2>
                        <p class="text-gray-500 mb-6">
                            This is where the V1 screenshot will be displayed. 
                            The old clunky table view will be shown here for contrast.
                        </p>
                        <div class="bg-gray-50 rounded-lg p-6 text-left">
                            <div class="text-sm text-gray-500 mb-2">Legacy Forecasting 1.0 Interface</div>
                            <div class="font-mono text-xs text-gray-400">
                                [Static table with basic metrics would be displayed here]
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Runtime enterprise theming via URL param (?theme=enterprise)
        (function applyRuntimeTheme() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('theme') === 'enterprise') {
                document.documentElement.style.setProperty('--border', '#98A2B3');
                document.documentElement.style.setProperty('--surface', '#FFFFFF');
                document.documentElement.style.setProperty('--surface-muted', '#F4F6F8');
                document.documentElement.style.setProperty('--brand-600', '#1F3AAE');
                document.body.style.background = '#EDF1F5';
                document.querySelectorAll('.kpi-card').forEach(el => {
                    el.style.borderWidth = '2px';
                    el.style.borderLeft = '6px solid var(--brand-600)';
                    el.style.background = 'var(--surface)';
                });
            }
        })();

        // App state
        let currentRole = 'ops';
        let isV1View = false;
        let selectedCampaign = null;
        let currentView = 'portfolio'; // portfolio, category, sku
        let selectedCategory = null;
        let selectedSKU = null;
        let selectedSKUName = null;
        let categoryChartScope = 'category'; // 'category' | 'portfolio'
        let selectedSubcategory = null; // subcategory within a category
        let selectedComparisons = []; // up to 2 competitor overlays
        let tableCompareSelection = []; // multi-select from SKUs list
        let selectedRetailer = 'all'; // 'all' | 'walmart' | 'amazon' | 'target'

        // Deep-linking helpers
        function readParams() {
            const p = new URLSearchParams(window.location.search);
            const view = p.get('view') || 'portfolio';
            const sanitize = (v) => v ? v.split(/[?&#]/)[0] : null;
            const cat = sanitize(p.get('cat'));
            const sku = sanitize(p.get('sku'));
            const sub = sanitize(p.get('sub'));
            const ret = sanitize(p.get('ret'));
            const camp = sanitize(p.get('camp'));
            return { view, cat, sku, sub, ret, camp };
        }

        function updateURL(view, cat, sku, replace=false) {
            // Start with a clean slate; do not preserve unrelated params like cache-busters
            const p = new URLSearchParams();
            // If we're on home (portfolio with no filters), keep the URL clean (no query params)
            const isCleanHome = view === 'portfolio' && !cat && !sku;
            let url = location.pathname;
            if (!isCleanHome) {
                p.set('view', view);
                if (cat) p.set('cat', cat);
                if (sku) p.set('sku', sku);
                if (selectedSubcategory) p.set('sub', selectedSubcategory);
                if (selectedCampaign) p.set('camp', selectedCampaign);
                if (selectedRetailer && selectedRetailer !== 'all') p.set('ret', selectedRetailer);
                url = `${location.pathname}?${p.toString()}`;
            }
            const state = { view, cat, sku };
            if (replace) history.replaceState(state, '', url); else history.pushState(state, '', url);
        }

        // Role descriptions
        const roleDescriptions = {
            ops: 'Revenue risk and inventory insights for operational decisions',
            engineer: 'Model performance and data quality metrics',
            marketer: 'Demand patterns and promotional effectiveness'
        };

        // Role-specific KPIs
            const roleKPIs = {
            ops: [
                { title: 'Inventory Risk', value: 'High', subtitle: '3 categories at risk', icon: 'package' },
                { title: 'Stockout Risk', value: 'Low', subtitle: '2 SKUs flagged', icon: 'alert-triangle' }
            ],
            engineer: [
                { title: 'Model Accuracy', value: '87.3%', subtitle: 'MAPE improvement', icon: 'bar-chart-3', change: '+2.1%' },
                { title: 'Data Quality', value: 'High', subtitle: '98.2% completeness', icon: 'eye' }
            ],
            marketer: [
                { title: 'Demand Spikes', value: '12', subtitle: 'SKUs with >20% increase', icon: 'trending-up' },
                { title: 'Promo Effectiveness', value: '+34%', subtitle: 'Average lift', icon: 'dollar-sign', change: '+8.2%' }
            ]
        };

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Hard kill-switch: remove any lingering "Portfolio Overview" hero block if present (handles cached HTML)
            try {
                const heroTitleNodes = Array.from(document.querySelectorAll('h1'));
                heroTitleNodes.forEach(node => {
                    if (node && typeof node.textContent === 'string' && node.textContent.trim() === 'Portfolio Overview') {
                        const heroBlock = node.closest('.mb-8');
                        if (heroBlock && heroBlock.parentElement) heroBlock.parentElement.removeChild(heroBlock);
                        else if (node.parentElement) node.parentElement.removeChild(node);
                    }
                });
                const roleDesc = document.getElementById('role-description');
                if (roleDesc && roleDesc.parentElement) roleDesc.parentElement.removeChild(roleDesc);
            } catch (_) {}
            // Guarded role switcher (buttons may be removed)
            const roleButtons = document.querySelectorAll('.role-btn');
            if (roleButtons && roleButtons.length) {
                roleButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.role-btn').forEach(b => b.classList.remove('active', 'bg-white', 'text-gray-900', 'shadow-sm'));
                    document.querySelectorAll('.role-btn').forEach(b => b.classList.add('text-gray-500'));
                    this.classList.add('active', 'bg-white', 'text-gray-900', 'shadow-sm');
                    this.classList.remove('text-gray-500');
                    currentRole = this.dataset.role;
                    updateRoleContent();
                });
            });
            }

            // Guarded V1/V2 toggle (element may be removed)
            const toggleEl = document.getElementById('v1-toggle');
            if (toggleEl) {
                toggleEl.addEventListener('click', function() {
                isV1View = !isV1View;
                toggleV1View();
            });
            }
            // Initial route from URL
            const { view, cat, sku, sub, camp } = readParams();
            currentView = view;
            selectedCategory = cat;
            selectedSKU = sku;
            selectedSubcategory = sub || null;
            selectedCampaign = camp || null;
            if (view === 'category') {
                showCategoryView();
            } else if (view === 'sku') {
                showSKUView();
            } else if (view === 'sku-detail') {
                showSKUDetail();
            } else {
                showPortfolioView();
                // Clean URL if we landed with extra params from cache-busting
                if (location.search) {
                    history.replaceState({ view: 'portfolio' }, '', location.pathname);
                }
            }

            // Mount portfolio chart if container exists
            setTimeout(renderPortfolioChart, 50);

            // Back/forward handling
            window.onpopstate = () => {
                const { view: v2, cat: c2, sku: s2, sub: sb, camp: cm } = readParams();
                currentView = v2;
                selectedCategory = c2;
                selectedSKU = s2;
                selectedSubcategory = sb || null;
                selectedCampaign = cm || null;
                if (v2 === 'category') showCategoryView();
                else if (v2 === 'sku') showSKUView();
                else if (v2 === 'sku-detail') showSKUDetail();
                else showPortfolioView();
                setTimeout(renderPortfolioChart, 50);
            };
        });

        // Fake data + Recharts render
        const chartData = [
            { month: '2024-07', actual: 4.6, baseline: 4.5, model: 4.6 },
            { month: '2024-08', actual: 4.9, baseline: 4.7, model: 4.8 },
            { month: '2024-09', actual: 4.7, baseline: 4.8, model: 4.7 },
            { month: '2024-10', actual: 5.1, baseline: 5.2, model: 5.3 },
            { month: '2024-11', actual: 5.4, baseline: 5.4, model: 5.6 },
            { month: '2024-12', actual: 5.7, baseline: 5.6, model: 5.9 }
        ];

        // Per-category fake series (same shape as portfolio but different values)
        const categorySeries = {
            electronics: [
                { month: '2024-07', actual: 0.8, baseline: 0.75, model: 0.78 },
                { month: '2024-08', actual: 0.86, baseline: 0.79, model: 0.83 },
                { month: '2024-09', actual: 0.84, baseline: 0.81, model: 0.82 },
                { month: '2024-10', actual: 0.89, baseline: 0.88, model: 0.92 },
                { month: '2024-11', actual: 0.93, baseline: 0.91, model: 0.95 },
                { month: '2024-12', actual: 0.96, baseline: 0.93, model: 0.98 }
            ],
            clothing: [
                { month: '2024-07', actual: 0.32, baseline: 0.36, model: 0.33 },
                { month: '2024-08', actual: 0.35, baseline: 0.37, model: 0.34 },
                { month: '2024-09', actual: 0.34, baseline: 0.36, model: 0.33 },
                { month: '2024-10', actual: 0.33, baseline: 0.35, model: 0.31 },
                { month: '2024-11', actual: 0.31, baseline: 0.34, model: 0.30 },
                { month: '2024-12', actual: 0.30, baseline: 0.33, model: 0.29 }
            ],
            toys: [
                { month: '2024-07', actual: 0.18, baseline: 0.20, model: 0.19 },
                { month: '2024-08', actual: 0.19, baseline: 0.21, model: 0.20 },
                { month: '2024-09', actual: 0.20, baseline: 0.22, model: 0.21 },
                { month: '2024-10', actual: 0.22, baseline: 0.24, model: 0.26 },
                { month: '2024-11', actual: 0.25, baseline: 0.26, model: 0.28 },
                { month: '2024-12', actual: 0.27, baseline: 0.28, model: 0.30 }
            ]
        };

        // Subcategory taxonomy per category (demo)
        const subcategories = {
            electronics: ['phones','laptops','audio','wearables'],
            clothing: ['tops','bottoms','outerwear','footwear'],
            toys: ['building','figures','games','outdoor']
        };

        function getCategoryDataFor(cat, sub) {
            const base = categorySeries[cat] || categorySeries.electronics;
            if (!sub) return base;
            const list = subcategories[cat] || [];
            const idx = Math.max(0, list.indexOf(sub));
            const factor = 0.7 + idx * 0.1; // subtle scaling per subcategory
            return base.map(p => ({
                month: p.month,
                actual: +(p.actual * factor).toFixed(2),
                baseline: +(p.baseline * factor).toFixed(2),
                model: +(p.model * (factor + 0.02 * (idx - 1))).toFixed(2)
            }));
        }

        function renderPortfolioChart() {
            const mount = document.getElementById('portfolio-chart');
            if (!mount) return;
            // Clear any previous render and unmount React component
            if (window.ReactDOM && ReactDOM.unmountComponentAtNode) {
                try { ReactDOM.unmountComponentAtNode(mount); } catch (_) {}
            }
            mount.innerHTML = '';
            const { ResponsiveContainer, LineChart, CartesianGrid, XAxis, YAxis, Tooltip, Legend, Line, ReferenceLine } = Recharts;

            function currency(v){ return `$${v.toFixed(2)}M`; }

            const Chart = () => (
                React.createElement(ResponsiveContainer, { width: '100%', height: '100%' },
                    React.createElement(LineChart, { data: chartData, margin: { top: 8, right: 24, left: 8, bottom: 8 } },
                        React.createElement(CartesianGrid, { strokeDasharray: '3 3', stroke: '#243244' }),
                        React.createElement(XAxis, { dataKey: 'month', tick: { fill: '#94A3B8' }, axisLine: { stroke: '#243244' } }),
                        React.createElement(YAxis, { tick: { fill: '#94A3B8' }, axisLine: { stroke: '#243244' }, tickFormatter: currency, domain: ['dataMin-0.2', 'dataMax+0.2'] }),
                        React.createElement(Tooltip, { contentStyle: { background:'#0B1220', border:'1px solid #243244', color:'#E5E7EB', borderRadius:8 }, labelStyle:{ color:'#E5E7EB' }, formatter: (v, n) => [currency(v), n === 'actual' ? 'Actuals' : n === 'baseline' ? 'Baseline' : 'Model Forecast'] }),
                        React.createElement(Legend, { verticalAlign: 'bottom', height: 24 }),
                        React.createElement(ReferenceLine, { x: '2024-10', stroke: '#64748B', strokeDasharray: '2 2' }),
                        React.createElement(Line, { type: 'monotone', dataKey: 'actual', name: 'Actuals', stroke: '#2563EB', dot: false, activeDot: { r: 5 }, strokeWidth: 2 }),
                        React.createElement(Line, { type: 'monotone', dataKey: 'baseline', name: 'Baseline', stroke: '#94A3B8', dot: false, strokeDasharray: '4 3', strokeWidth: 2 }),
                        React.createElement(Line, { type: 'monotone', dataKey: 'model', name: 'Model Forecast', stroke: '#EF4444', dot: false, activeDot: { r: 5 }, strokeWidth: 2 })
                    )
                )
            );

            ReactDOM.render(React.createElement(Chart), mount);
        }

        function renderCategoryChart() {
            const mount = document.getElementById('category-chart');
            if (!mount) return;
            // Fully unmount any previous chart to avoid stale internal state
            if (window.ReactDOM && ReactDOM.unmountComponentAtNode) {
                try { ReactDOM.unmountComponentAtNode(mount); } catch (_) {}
            }
            mount.innerHTML = '';
            const subtitleEl = document.getElementById('category-chart-subtitle');
            const activeCat = selectedCategory || 'electronics';
            const data = categoryChartScope === 'portfolio' ? (Array.isArray(chartData) ? chartData.slice() : []) : getCategoryDataFor(activeCat, selectedSubcategory);
            if (subtitleEl) {
                const label = categoryChartScope === 'portfolio' ? 'Portfolio (all categories)' : `Category: ${activeCat}${selectedSubcategory ? ' / ' + selectedSubcategory : ''}`;
                subtitleEl.textContent = label;
            }
            const { ResponsiveContainer, LineChart, CartesianGrid, XAxis, YAxis, Tooltip, Legend, Line, ReferenceLine } = Recharts;
            function currency(v){ return `$${v.toFixed(2)}M`; }
            const Chart = () => (
                React.createElement(ResponsiveContainer, { width: '100%', height: '100%' },
                    React.createElement(LineChart, { data, margin: { top: 8, right: 24, left: 8, bottom: 24 } },
                        React.createElement(CartesianGrid, { strokeDasharray: '3 3', stroke: '#243244' }),
                        React.createElement(XAxis, { dataKey: 'month', tick: { fill: '#94A3B8' }, tickMargin: 8, interval: 'preserveEnd', axisLine: { stroke: '#243244' } }),
                        React.createElement(YAxis, { tick: { fill: '#94A3B8' }, width: 60, axisLine: { stroke: '#243244' }, domain: ['dataMin-0.2', 'auto'], tickFormatter: currency }),
                        React.createElement(Tooltip, { contentStyle: { background:'#0B1220', border:'1px solid #243244', color:'#E5E7EB', borderRadius:8 }, labelStyle:{ color:'#E5E7EB' }, formatter: (v, n) => [currency(v), n === 'actual' ? 'Actuals' : n === 'baseline' ? 'Baseline' : 'Model Forecast'] }),
                        React.createElement(Legend, { verticalAlign: 'bottom', height: 24 }),
                        React.createElement(ReferenceLine, { x: '2024-10', stroke: '#64748B', strokeDasharray: '2 2' }),
                        React.createElement(Line, { type: 'monotone', dataKey: 'actual', name: 'Actuals', stroke: '#2563EB', dot: false, activeDot: { r: 5 }, strokeWidth: 2 }),
                        React.createElement(Line, { type: 'monotone', dataKey: 'baseline', name: 'Baseline', stroke: '#94A3B8', dot: false, strokeDasharray: '4 3', strokeWidth: 2 }),
                        React.createElement(Line, { type: 'monotone', dataKey: 'model', name: 'Model Forecast', stroke: '#EF4444', dot: false, activeDot: { r: 5 }, strokeWidth: 2 })
                    )
                )
            );
            ReactDOM.render(React.createElement(Chart), mount);
        }

        function populateCompareDropdown() {
            const ddl = document.getElementById('comp-select');
            if (!ddl || !selectedCategory) return;
            const list = generateSKUs(selectedCategory);
            ddl.innerHTML = '<option value="">Compare with…</option>' +
                list.slice(0, 12).map(s => {
                    const returns = s.returnRate.toFixed(1);
                    const rating = s.reviewScore.toFixed(1);
                    const warning = (s.returnRate > 15 || s.reviewScore < 3.5) ? ' ⚠️' : '';
                    return `<option value="${s.id}" ${s.id===selectedSKU?'disabled':''}>${s.name} | ${returns}% returns | ${rating}/5 rating${warning}</option>`;
                }).join('');
            const addBtn = document.getElementById('comp-add');
            if (addBtn) addBtn.onclick = () => {
                const val = ddl.value;
                if (!val) return;
                if (val === selectedSKU) return;
                if (selectedComparisons.includes(val)) return;
                if (selectedComparisons.length >= 2) { selectedComparisons.shift(); }
                selectedComparisons.push(val);
                renderCompareChips();
                renderSKUHistoricalChart();
            };
        }

        function renderCompareChips() {
            const wrap = document.getElementById('comp-chips');
            if (!wrap) return;
            const list = generateSKUs(selectedCategory);
            wrap.innerHTML = selectedComparisons.map(id => {
                const s = list.find(x => x.id === id);
                const label = s ? s.name : id;
                return `<span class="inline-flex items-center gap-1 px-2 py-0.5 text-xs rounded-md bg-gray-100 text-gray-700">${label}<button data-rm="${id}" class="text-gray-500 hover:text-gray-800">×</button></span>`;
            }).join('');
            wrap.querySelectorAll('[data-rm]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.getAttribute('data-rm');
                    selectedComparisons = selectedComparisons.filter(x => x !== id);
                    renderCompareChips();
                    renderSKUHistoricalChart();
                });
            });
        }

        function updateCategoryScopeButtons() {
            const btnCat = document.getElementById('btn-scope-category');
            const btnPort = document.getElementById('btn-scope-portfolio');
            if (!btnCat || !btnPort) return;
            if (categoryChartScope === 'category') {
                btnCat.classList.add('bg-white','shadow-sm','border');
                btnCat.classList.remove('text-gray-600');
                btnPort.classList.remove('bg-white','shadow-sm','border');
                btnPort.classList.add('text-gray-600');
            } else {
                btnPort.classList.add('bg-white','shadow-sm','border');
                btnPort.classList.remove('text-gray-600');
                btnCat.classList.remove('bg-white','shadow-sm','border');
                btnCat.classList.add('text-gray-600');
            }
        }

        // Helper when clicking a category tile to keep scope UI intact
        function chooseCategory(cat) {
            selectedCategory = cat;
            selectedSubcategory = null;
            currentView = 'category';
            updateBreadcrumbs();
            showCategoryView();
            updateURL('category', selectedCategory, null);
        }

        // ---------- SKU detail charts & action ----------
        function buildSKUBaseSeries() {
            // Generate SKU-specific data with realistic variation
            return chartData.map((p, i) => {
                const noise = Math.sin(i * 0.7) * 0.08; // Smooth variation
                return {
                    month: p.month,
                    actual: Math.max(0.1, p.actual * 0.95 + noise), // Scale down slightly, add noise
                    baseline: p.baseline * 0.93 + noise * 0.5,
                    model: p.model * 0.94 + noise * 0.7
                };
            });
        }

        function renderSKUHistoricalChart() {
            const mount = document.getElementById('sku-historical-chart');
            if (!mount) return;
            if (window.ReactDOM && ReactDOM.unmountComponentAtNode) { try { ReactDOM.unmountComponentAtNode(mount); } catch(_){} }
            mount.innerHTML = '';
            const base = buildSKUBaseSeries();
            const data = selectedRetailer === 'all' ? base : scaleSeries(base, getRetailerFactor(selectedRetailer));
            const list = generateSKUs(selectedCategory || 'electronics');
            const overlays = (selectedComparisons || []).map((id, idx) => {
                const colorPalette = ['#9333EA','#059669'];
                const color = colorPalette[idx % colorPalette.length];
                return { id, color };
            });
            const { ResponsiveContainer, LineChart, CartesianGrid, XAxis, YAxis, Tooltip, Legend, Line, ReferenceLine } = Recharts;
            function currency(v){ return `$${v.toFixed(2)}M`; }
            const events = [
                { month: '2024-08', label: '' },
                { month: '2024-11', label: '' }
            ];
            const Chart = () => (
                React.createElement(ResponsiveContainer, { width: '100%', height: '100%' },
                    React.createElement(LineChart, { data: data, margin: { top: 20, right: 24, left: 8, bottom: 8 } },
                        React.createElement(CartesianGrid, { strokeDasharray: '3 3', stroke: '#E5E7EB' }),
                        React.createElement(XAxis, { dataKey: 'month', tick: { fill: '#64748B' }, axisLine: { stroke: '#CBD5E1' } }),
                        React.createElement(YAxis, { tick: { fill: '#64748B' }, width: 60, tickFormatter: currency, axisLine: { stroke: '#CBD5E1' } }),
                        React.createElement(Tooltip, { formatter: (v, n) => [currency(v), n==='actual'?'Actuals':n==='baseline'?'Baseline':'Model'] }),
                        React.createElement(Legend, { verticalAlign: 'bottom', height: 24 }),
                        React.createElement(Line, { type: 'monotone', dataKey: 'actual', name: 'Actuals', stroke: '#2563EB', dot: false, strokeWidth: 2 }),
                        React.createElement(Line, { type: 'monotone', dataKey: 'baseline', name: 'Baseline', stroke: '#64748B', dot: false, strokeWidth: 2 }),
                        React.createElement(Line, { type: 'monotone', dataKey: 'model', name: 'Model', stroke: '#EF4444', dot: false, strokeWidth: 2 }),
                        ...overlays.map((ov, idx) => React.createElement(Line, {
                            key: `comp-${ov.id}`,
                            type: 'monotone',
                            dataKey: 'model',
                            name: (list.find(x => x.id === ov.id)?.name || ov.id),
                            stroke: ov.color,
                            dot: false,
                            strokeWidth: 2
                        })),
                        ...events.map(e => React.createElement(ReferenceLine, { key: e.month, x: e.month, stroke: '#CBD5E1', strokeDasharray: '3 3', isFront: true }))
                    )
                )
            );
            ReactDOM.render(React.createElement(Chart), mount);
        }

        function renderSKUProjectionChart() {
            const mount = document.getElementById('sku-projection-chart');
            if (!mount) return;
            if (window.ReactDOM && ReactDOM.unmountComponentAtNode) { try { ReactDOM.unmountComponentAtNode(mount); } catch(_){} }
            mount.innerHTML = '';
            const { ResponsiveContainer, AreaChart, CartesianGrid, XAxis, YAxis, Tooltip, Area, Legend } = Recharts;
            function currency(v){ return `$${v.toFixed(2)}M`; }
            // Next 3 months projection with bands
            const last = chartData[chartData.length-1]?.model || 4.7;
            const months = ['M+1','M+2','M+3'];
            const proj = months.map((m, i) => {
                const mean = last + 0.2*(i+1);
                const band = 0.25 + i*0.05;
                return { month: m, lower: Math.max(0, mean - band), mean, upper: mean + band };
            });
            const factor = getRetailerFactor(selectedRetailer);
            const scaled = selectedRetailer==='all' ? proj : proj.map(p => ({ month:p.month, lower: +(p.lower*factor).toFixed(2), mean: +(p.mean*factor).toFixed(2), upper: +(p.upper*factor).toFixed(2) }));
            const Chart = () => (
                React.createElement(ResponsiveContainer, { width: '100%', height: '100%' },
                    React.createElement(AreaChart, { data: scaled, margin: { top: 8, right: 24, left: 8, bottom: 8 }, style: { backgroundColor: 'transparent' } },
                        React.createElement(CartesianGrid, { strokeDasharray: '3 3', stroke: '#F1F5F9' }),
                        React.createElement(XAxis, { dataKey: 'month', tick: { fill: '#64748B' } }),
                        React.createElement(YAxis, { tick: { fill: '#64748B' }, width: 60, tickFormatter: currency }),
                        React.createElement(Tooltip, { formatter: (v) => currency(v) }),
                        React.createElement(Legend, { verticalAlign: 'bottom', height: 24 }),
                        React.createElement(Area, { type: 'monotone', dataKey: 'upper', stroke: '#94A3B8', fill: 'transparent', fillOpacity: 0, dot: false }),
                        React.createElement(Area, { type: 'monotone', dataKey: 'lower', stroke: '#94A3B8', fill: 'transparent', fillOpacity: 0, dot: false }),
                        React.createElement(Area, { type: 'monotone', dataKey: 'mean', name: 'Forecast', stroke: '#7C3AED', fill: 'none', strokeWidth: 2 })
                    )
                )
            );
            ReactDOM.render(React.createElement(Chart), mount);
        }

        function renderSKUAction() {
            const el = document.getElementById('sku-action-card');
            if (!el) return;
            const rec = getSKUActionRecommendation();
            // Rail color and subtle tint based on action type
            const rail = document.getElementById('sku-action-rail');
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const palette = rec.action === 'Markdown'
                ? { rail: '#DC2626', tint: isDark ? 'rgba(239,68,68,0.18)' : 'rgba(220,38,38,0.06)', border: isDark ? 'rgba(239,68,68,0.60)' : '#FECACA' }
                : rec.action === 'Investigate'
                ? { rail: 'var(--accent-amber-600)', tint: isDark ? 'rgba(245,158,11,0.18)' : 'rgba(217,119,6,0.08)', border: isDark ? 'rgba(245,158,11,0.60)' : '#FDE68A' }
                : { rail: '#2563EB', tint: isDark ? 'rgba(96,165,250,0.18)' : 'rgba(37,99,235,0.06)', border: isDark ? 'rgba(96,165,250,0.60)' : 'rgba(37,99,235,0.16)' };
            if (rail) rail.style.backgroundColor = palette.rail;
            // Card styles per your direction
            // Use requested dark fill when in dark theme so color changes are visible
            const targetFill = isDark ? '#28324E' : palette.tint;
            el.style.backgroundColor = targetFill;
            const actionWrap = document.getElementById('sku-action-wrap');
            if (actionWrap) {
                actionWrap.classList.add('card_highlight');
                actionWrap.style.backgroundColor = targetFill;
                actionWrap.style.border = '2px solid rgba(96,165,250,0.60)';
                actionWrap.style.boxShadow = '0 0 0 1px rgba(96,165,250,0.45)';
            }
            // Stock & Risk: apply a related tint and subtle colored border to indicate relationship
            const stockWrap = document.getElementById('sku-stock-card');
            if (stockWrap) {
                stockWrap.style.backgroundColor = palette.tint;
                stockWrap.style.borderTop = '';
                stockWrap.style.border = `1px solid var(--border)`; // match lower cards
                stockWrap.style.borderRadius = '0.75rem';
                stockWrap.style.boxShadow = '';
            }
            el.innerHTML = `
                <div class="flex items-start justify-between mb-3">
                    <div>
                        <div class="ra-label text-xs uppercase tracking-wide mb-1">RECOMMENDED ACTION</div>
                        <div class="text-xl font-semibold text-gray-900">${rec.headline}</div>
                    </div>
                    ${rec.priorityHTML}
                </div>
                <div class="mb-3 flex flex-wrap gap-x-4 gap-y-2">
                    ${rec.metricChipsHTML}
                </div>
                <ul class="text-sm text-gray-800 list-disc pl-5 space-y-1 mb-2">
                    ${rec.reasons.map(r => `<li>${r}</li>`).join('')}
                </ul>
                <div class="flex items-center gap-3">${rec.suggestionHTML} ${rec.calcHTML}</div>
                <div id="sku-calc" class="hidden mt-3 p-3 bg-white border border-gray-200 rounded-md text-sm text-gray-700">
                    ${rec.calcDetailsHTML || ''}
                </div>
            `;
            lucide.createIcons();
            const btn = document.getElementById('execute-action-btn');
            if (btn) btn.onclick = () => openActionModal(rec);
            const calcBtn = document.getElementById('btn-calc');
            const calcBox = document.getElementById('sku-calc');
            if (calcBtn && calcBox) {
                calcBtn.onclick = () => {
                    if (calcBox.classList.contains('hidden')) {
                        calcBox.classList.remove('hidden');
                    } else {
                        calcBox.classList.add('hidden');
                    }
                };
            }
            renderStockRiskCard();
        }

        function renderStockRiskCard() {
            const el = document.getElementById('sku-stock-card');
            if (!el) return;
            // Use the same synthetic numbers used by recommendation
            const weeklyForecast = 120;
            const stockOnHand = 380;
            const targetWOS = 6;
            const wos = stockOnHand / weeklyForecast;
            const risk = wos < 3 ? 'High' : wos < 5 ? 'Medium' : 'Low';
            const pct = Math.min(100, Math.round((stockOnHand / (targetWOS*weeklyForecast)) * 100));
            el.innerHTML = `
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Stock & Risk</h3>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between"><span class="text-gray-500">Stock on hand</span><span class="font-medium">${stockOnHand} units</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Weeks of supply</span><span class="font-medium">${wos.toFixed(1)}</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Target WOS</span><span class="font-medium">${targetWOS}</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Risk level</span><span class="font-medium ${wos<3?'text-red-600':wos<5?'text-[var(--accent-amber-700)]':'text-green-700'}">${risk}</span></div>
                </div>
                <div class="mt-4">
                    <div class="flex justify-between text-xs text-gray-500 mb-1">
                        <span>Stock vs target</span><span>${pct}%</span>
                    </div>
                    <div class="h-2 w-full bg-gray-100 rounded">
                        <div class="h-2 bg-blue-600 rounded" style="width:${pct}%"></div>
                    </div>
                </div>
            `;
        }

        function getSKUActionRecommendation() {
            // Synthetic values for demo purposes
            const weeklyForecast = 120; // units/week
            const stockOnHand = 380; // units
            const wos = stockOnHand / weeklyForecast; // weeks of supply
            const lift = 22; // % vs baseline
            const confidence = 87; // %
            const modelMAPE = 8.2; // %
            const baselineMAPE = 15.7; // %
            const improvement = baselineMAPE - modelMAPE; // pp

            let action = 'Hold';
            const reasons = [];
            let suggestionHTML = '';
            let priorityHTML = '';
            let metricChipsHTML = '';
            let headline = '';
            let calcHTML = '';
            let calcDetailsHTML = '';

            if (lift >= 10 && confidence >= 70 && wos < 4) {
                action = 'Reorder';
                const targetWOS = 6;
                const qty = Math.max(0, Math.ceil(targetWOS * weeklyForecast - stockOnHand));
                reasons.push(`Forecast lift +${lift}%, confidence ${confidence}%`);
                reasons.push(`Weeks of supply ${wos.toFixed(1)} < target ${targetWOS}`);
                headline = `Reorder ${qty} units`;
                suggestionHTML = `<button id="execute-action-btn" class="btn btn-primary">Execute Reorder (${qty} units)</button>`;
                calcHTML = `<button class="btn btn-secondary" id="btn-calc">View calculation</button>`;
                calcDetailsHTML = `
                    <div class="font-semibold text-gray-900 mb-2">Reorder quantity calculation</div>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <div class="text-gray-500">Target WOS</div><div>${targetWOS} weeks</div>
                        <div class="text-gray-500">Weekly forecast</div><div>${weeklyForecast} units/week</div>
                        <div class="text-gray-500">Stock on hand</div><div>${stockOnHand} units</div>
                    </div>
                    <div class="font-mono text-sm text-gray-800">qty = max(0, ceil(${targetWOS} × ${weeklyForecast} − ${stockOnHand})) = ${qty} units</div>`;
                if (wos < 3) priorityHTML = `<span class="inline-flex items-center text-xs font-medium px-2 py-1 rounded-md bg-red-50 text-red-700 border border-red-200">High priority</span>`;
            } else if ((lift <= -10 || wos > 10) && confidence >= 60 && improvement >= 5) {
                action = 'Markdown';
                const discount = Math.min(30, Math.max(10, Math.round((wos - 8) * 3)));
                reasons.push(`Demand down/Large overstock (WOS ${wos.toFixed(1)})`);
                reasons.push(`Model beats baseline by ${improvement.toFixed(1)}pp`);
                headline = `Markdown ${discount}%`;
                suggestionHTML = `<button id="execute-action-btn" class="btn btn-primary">Execute Markdown (${discount}% off)</button>`;
                calcHTML = `<button class="btn btn-secondary" id="btn-calc">View calculation</button>`;
                calcDetailsHTML = `
                    <div class="font-semibold text-gray-900 mb-2">Markdown calculation</div>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <div class="text-gray-500">Weeks of supply</div><div>${wos.toFixed(1)} weeks</div>
                        <div class="text-gray-500">Threshold</div><div>8 weeks</div>
                        <div class="text-gray-500">Heuristic</div><div>discount = min(30%, (WOS − 8) × 3%)</div>
                    </div>
                    <div class="font-mono text-sm text-gray-800">discount = min(30%, (${wos.toFixed(1)} − 8) × 3%)</div>`;
            } else if (confidence < 55 || modelMAPE >= 15) {
                action = 'Investigate';
                reasons.push(`Low predictability (confidence ${confidence}%, MAPE ${modelMAPE}%)`);
                headline = 'Open Investigation';
                suggestionHTML = `<button id="execute-action-btn" class="btn btn-secondary">Open Investigation</button>`;
            } else {
                reasons.push('Monitor next 2 weeks; metrics within thresholds');
                headline = 'Set Watch';
                suggestionHTML = `<button id="execute-action-btn" class="btn btn-secondary">Set Watch</button>`;
            }

            metricChipsHTML = `
                <span class="inline-flex items-center text-xs font-medium px-2 py-1 rounded-md bg-gray-100 text-gray-700">Lift +${lift}%</span>
                <span class="inline-flex items-center text-xs font-medium px-2 py-1 rounded-md bg-gray-100 text-gray-700">Confidence ${confidence}%</span>
                <span class="inline-flex items-center text-xs font-medium px-2 py-1 rounded-md bg-gray-100 text-gray-700">WOS ${wos.toFixed(1)}</span>`;

            return { action, reasons, suggestionHTML, priorityHTML, metricChipsHTML, headline, calcHTML, calcDetailsHTML };
        }

        // No spark in Option A layout

        function openActionModal(rec) {
            // Get manufacturer from selected SKU
            const skuList = generateSKUs(selectedCategory || 'electronics');
            const sku = skuList.find(s => s.id === selectedSKU);
            const manufacturer = sku ? sku.manufacturer : 'Unknown';
            const skuName = sku ? sku.name : selectedSKU;
            
            // Build action-specific message
            let message = `This will queue the action for Ops. Proceed?`;
            if (rec.action === 'Reorder') {
                message = `This will queue a reorder from <strong>${manufacturer}</strong> for ${skuName}. Proceed?`;
            }
            
            // Simple confirm modal
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50';
            overlay.innerHTML = `
                <div class="bg-white rounded-lg border border-gray-200 p-6 w-full max-w-md shadow-lg">
                    <h4 class="text-lg font-semibold text-gray-900 mb-2">Confirm ${rec.action}</h4>
                    <p class="text-sm text-gray-600 mb-4">${message}</p>
                    <div class="flex justify-end space-x-2">
                        <button id="modal-cancel" class="btn btn-secondary">Cancel</button>
                        <button id="modal-confirm" class="btn btn-primary">Confirm</button>
                    </div>
                </div>`;
            document.body.appendChild(overlay);
            document.getElementById('modal-cancel').onclick = () => overlay.remove();
            document.getElementById('modal-confirm').onclick = () => {
                console.log('Action executed:', rec.action, 'for', selectedSKU, 'from', manufacturer);
                overlay.remove();
                alert('Action queued successfully.');
            };
        }

        function updateRoleContent() {
            // Update description (element may not exist)
            const descEl = document.getElementById('role-description');
            if (descEl) {
                descEl.textContent = roleDescriptions[currentRole];
            }
            
            // Update role-specific KPIs (container exists only on portfolio view)
            const kpiContainer = document.getElementById('role-specific-kpis');
            if (!kpiContainer) return;
            const kpis = roleKPIs[currentRole];
            
            kpiContainer.innerHTML = kpis.map(kpi => `
                    <div class="bg-white rounded-lg border border-gray-200 p-6 shadow-sm kpi-inventory-border">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500 mb-1">${kpi.title}</p>
                            <p class="text-2xl font-semibold text-gray-900">${kpi.value}</p>
                            <p class="text-sm text-gray-500 mt-1">${kpi.subtitle}</p>
                        </div>
                        <div class="text-blue-600">
                            <i data-lucide="${kpi.icon}" class="w-6 h-6"></i>
                        </div>
                    </div>
                    ${kpi.change ? `
                        <div class="flex items-center space-x-1 mt-3">
                            <i data-lucide="trending-up" class="w-4 h-4 text-green-600"></i>
                            <span class="text-sm font-medium text-green-600">${kpi.change}</span>
                        </div>
                    ` : ''}
                </div>
            `).join('');
            
            // Re-initialize icons
            lucide.createIcons();
        }

        function toggleV1View() {
            const mainApp = document.getElementById('app');
            const v1View = document.getElementById('v1-view');
            const toggleBtn = document.getElementById('v1-toggle');
            
            if (isV1View) {
                mainApp.classList.add('hidden');
                v1View.classList.remove('hidden');
                toggleBtn.innerHTML = `
                    <i data-lucide="toggle-left" class="w-4 h-4 text-gray-400"></i>
                    <span class="text-sm text-gray-500">V1 View</span>
                `;
            } else {
                mainApp.classList.remove('hidden');
                v1View.classList.add('hidden');
                toggleBtn.innerHTML = `
                    <i data-lucide="toggle-right" class="w-4 h-4 text-blue-600"></i>
                    <span class="text-sm text-blue-600">V2 View</span>
                `;
            }
            
            // Re-initialize icons
            lucide.createIcons();
        }

        // Drilldown functionality
        function drillDown(type) {
            if (type === 'portfolio') {
                showCategories();
            } else if (type === 'forecast') {
                showForecastDetail();
            } else if (type === 'misses') {
                showMisses();
            }
        }

        function showCategories() {
            currentView = 'category';
            updateBreadcrumbs();
            showCategoryView();
            updateURL('category', selectedCategory, selectedSKU);
        }

        function showCategoryView() {
            const mainContent = document.querySelector('main');
            mainContent.innerHTML = `
                <div class="mb-8">
                    <h1 class="text-3xl font-semibold text-gray-900 mb-2">Categories</h1>
                    <p class="text-gray-500">Drill down into category performance</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="kpi-card card-hover card p-6 shadow-sm cursor-pointer" onclick="chooseCategory('electronics')">
                        <div class="flex items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">Electronics</h3>
                        </div>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-500">Revenue</span>
                                <span class="font-semibold text-gray-900">$850K</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-500">Forecast</span>
                                <span class="font-semibold text-positive">+22%</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-500">Confidence</span>
                                <span class="font-semibold text-positive">High (87%)</span>
                            </div>
                        </div>
                        <div class="mt-4 text-sm text-gray-600">
                            Supply down. <button type="button" class="text-blue-600 hover:underline font-medium">Reorder now.</button>
                        </div>
                            <div class="mt-4 flex justify-end">
                                <button class="btn btn-primary text-xs px-3 py-1" onclick="event.stopPropagation(); selectCategory('electronics')">View SKUs</button>
                            </div>
                    </div>

                    <div class="kpi-card card-hover card p-6 shadow-sm cursor-pointer" onclick="chooseCategory('clothing')">
                        <div class="flex items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">Clothing</h3>
                        </div>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-500">Revenue</span>
                                <span class="font-semibold text-gray-900">$420K</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-500">Forecast</span>
                                <span class="font-semibold text-negative">-8%</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-500">Confidence</span>
                                <span class="font-semibold text-negative">Low (35%)</span>
                            </div>
                        </div>
                        <div class="mt-4 text-sm text-gray-600">
                            Sparse history. <button type="button" class="text-blue-600 hover:underline font-medium">Investigate</button>.
                        </div>
                            <div class="mt-4 flex justify-end">
                                <button class="btn btn-primary text-xs px-3 py-1" onclick="event.stopPropagation(); selectCategory('clothing')">View SKUs</button>
                            </div>
                    </div>

                    <div class="kpi-card card-hover card p-6 shadow-sm cursor-pointer" onclick="chooseCategory('toys')">
                        <div class="flex items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">Toys & Games</h3>
                        </div>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-500">Revenue</span>
                                <span class="font-semibold text-gray-900">$180K</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-500">Forecast</span>
                                <span class="font-semibold text-negative">-15%</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-500">Confidence</span>
                                <span class="font-semibold text-positive">High (78%)</span>
                            </div>
                        </div>
                        <div class="mt-4 text-sm text-gray-600">
                            Overstock risk (WOS &gt; 8). <button type="button" class="text-blue-600 hover:underline font-medium">Apply markdown</button>.
                        </div>
                            <div class="mt-4 flex justify-end">
                                <button class="btn btn-primary text-xs px-3 py-1" onclick="event.stopPropagation(); selectCategory('toys')">View SKUs</button>
                            </div>
                    </div>
                </div>

                <div class="card p-6">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-lg font-semibold text-gray-900">Category Performance</h3>
                        <div class="inline-flex bg-gray-100 rounded-md p-1">
                            <button id="btn-scope-category" class="px-3 py-1 text-sm rounded-md bg-white shadow-sm">Category</button>
                            <button id="btn-scope-portfolio" class="px-3 py-1 text-sm rounded-md text-gray-600">Portfolio</button>
                        </div>
                    </div>
                    <div id="category-chart-subtitle" class="text-sm text-gray-500 mb-2"></div>
                    <div class="h-80 bg-white rounded-lg">
                        <div id="category-chart" class="w-full h-full"></div>
                    </div>
                </div>
            `;
            
            // Re-initialize icons
            lucide.createIcons();
            // Wire scope buttons
            const btnCat = document.getElementById('btn-scope-category');
            const btnPort = document.getElementById('btn-scope-portfolio');
            if (btnCat && btnPort) {
                btnCat.onclick = () => { if (categoryChartScope !== 'category') { categoryChartScope = 'category'; updateCategoryScopeButtons(); renderCategoryChart(); } };
                btnPort.onclick = () => { if (categoryChartScope !== 'portfolio') { categoryChartScope = 'portfolio'; updateCategoryScopeButtons(); renderCategoryChart(); } };
            }
            // Render subcategory chips when a category is chosen
            const subWrap = document.getElementById('subcategory-filter');
            if (subWrap && selectedCategory) {
                const subs = subcategories[selectedCategory] || [];
                const allActive = !selectedSubcategory ? 'bg-white shadow-sm border' : 'text-gray-600';
                const chips = [`<button id="sub-all" class="px-3 py-1 text-sm rounded-md mr-2 ${allActive}">All</button>`]
                    .concat(subs.map(s => {
                        const active = selectedSubcategory === s ? 'bg-white shadow-sm border' : 'text-gray-600';
                        return `<button data-sub="${s}" class="px-3 py-1 text-sm rounded-md mr-2 ${active}">${s}</button>`;
                    })).join('');
                subWrap.innerHTML = `<div class="inline-flex bg-gray-100 rounded-md p-1">${chips}</div>`;
                const allBtn = document.getElementById('sub-all');
                if (allBtn) allBtn.onclick = () => { selectedSubcategory = null; updateURL('category', selectedCategory, null); renderCategoryChart(); showCategoryView(); };
                (subcategories[selectedCategory] || []).forEach(s => {
                    const el = subWrap.querySelector(`[data-sub="${s}"]`);
                    if (el) el.onclick = () => { selectedSubcategory = s; updateURL('category', selectedCategory, null); renderCategoryChart(); showCategoryView(); };
                });
            }
            updateCategoryScopeButtons();
            setTimeout(renderCategoryChart, 50);
        }

        function selectCategory(categoryId) {
            selectedCategory = categoryId;
            currentView = 'sku';
            updateBreadcrumbs();
            showSKUView();
            updateURL('sku', selectedCategory, selectedSKU);
            setTimeout(renderCategoryChart, 50);
        }

        function showSKUView() {
            const mainContent = document.querySelector('main');
            const skuRows = buildSKURows(selectedCategory || 'electronics', selectedSubcategory);
            mainContent.innerHTML = `
                <div class="mb-8 flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-semibold text-gray-900 mb-2">SKUs - ${selectedCategory}</h1>
                        <p class="text-gray-500">Individual SKU performance and actions</p>
                    </div>
                    <button id="export-btn" class="btn btn-secondary flex items-center gap-2">
                        <i data-lucide="download" class="w-4 h-4"></i>
                        Export to Excel
                    </button>
                </div>
                <div id="unified-filter-bar" class="mb-6"></div>
                <div class="bg-white rounded-xl border border-gray-200 shadow-lg overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SKU</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Revenue</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Units</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Miss Rate</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Confidence</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${skuRows}
                            </tbody>
                        </table>
                                            </div>
                                        </div>
            `;
            
            // Re-initialize icons
            lucide.createIcons();

            // Render unified filter bar (subcategory tabs + campaign dropdown)
            const filterBar = document.getElementById('unified-filter-bar');
            if (filterBar) {
                const subs = subcategories[selectedCategory] || [];
                const campaigns = ['Holiday 2025', 'Back to School', 'Summer Sale'];
                
                // Build subcategory tabs (larger, primary)
                const allActive = !selectedSubcategory ? 'bg-white shadow-sm border border-gray-300 text-gray-900 font-medium' : 'text-gray-500 hover:text-gray-700';
                const subTabs = [`<button id="sub2-all" class="px-4 py-2 text-sm rounded-md mr-2 transition-colors ${allActive}">All</button>`]
                    .concat(subs.map(s => {
                        const active = selectedSubcategory === s ? 'bg-white shadow-sm border border-gray-300 text-gray-900 font-medium' : 'text-gray-500 hover:text-gray-700';
                        return `<button data-sub2="${s}" class="px-4 py-2 text-sm rounded-md mr-2 transition-colors ${active}">${s}</button>`;
                    })).join('');
                
                // Build campaign dropdown (compact, secondary)
                const campaignLabel = selectedCampaign || 'All Campaigns';
                const campaignDropdown = `
                    <div class="relative inline-block">
                        <label class="text-xs text-gray-400 uppercase tracking-wide mr-2">Campaign:</label>
                        <select id="campaign-select" class="input text-sm py-1.5 px-3 pr-8 appearance-none cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors" style="background-image: url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 24 24%27 fill=%27none%27 stroke=%27currentColor%27 stroke-width=%272%27%3e%3cpolyline points=%276 9 12 15 18 9%27/%3e%3c/svg%3e'); background-repeat: no-repeat; background-position: right 0.5rem center; background-size: 1.25em;">
                            <option value="">All Campaigns</option>
                            ${campaigns.map(c => `<option value="${c}" ${selectedCampaign === c ? 'selected' : ''}>${c}</option>`).join('')}
                        </select>
                    </div>
                `;
                
                filterBar.innerHTML = `
                    <div class="flex items-center justify-between bg-gray-50 border border-gray-200 rounded-lg p-3">
                        <div class="inline-flex bg-gray-100 rounded-md p-1">${subTabs}</div>
                        ${campaignDropdown}
                    </div>
                `;
                
                // Wire up subcategory tab clicks
                const allBtn2 = document.getElementById('sub2-all');
                if (allBtn2) allBtn2.onclick = () => { selectedSubcategory = null; updateURL('sku', selectedCategory, null); showSKUView(); };
                subs.forEach(s => {
                    const el = filterBar.querySelector(`[data-sub2="${s}"]`);
                    if (el) el.onclick = () => { selectedSubcategory = s; updateURL('sku', selectedCategory, null); showSKUView(); };
                });
                
                // Wire up campaign dropdown
                const campaignSelect = document.getElementById('campaign-select');
                if (campaignSelect) {
                    campaignSelect.onchange = (e) => {
                        selectedCampaign = e.target.value || null;
                        updateURL('sku', selectedCategory, null);
                        showSKUView();
                    };
                }
            }

            // Wire up export button
            const exportBtn = document.getElementById('export-btn');
            if (exportBtn) {
                exportBtn.onclick = () => exportSKUData(selectedCategory || 'electronics', selectedSubcategory);
            }
        }

        function exportSKUData(categoryId, subcat) {
            let data = generateSKUs(categoryId, subcat);
            // Apply same campaign filter as table
            if (selectedCampaign) {
                data = data.filter(row => row.campaign === selectedCampaign);
            }

            // Build CSV with proper headers
            const headers = ['SKU', 'Category', 'Campaign', 'Revenue', 'Units', 'Miss Rate', 'Confidence', 'Action'];
            const csvRows = [headers.join(',')];

            data.forEach(row => {
                const csvRow = [
                    `"${row.name}"`,
                    `"${row.categoryLabel}"`,
                    row.campaign ? `"${row.campaign}"` : '',
                    row.revenue.replace(/[$,]/g, ''),
                    row.units,
                    row.missRate,
                    row.confidence,
                    `"${row.action}"`
                ];
                csvRows.push(csvRow.join(','));
            });

            const csvContent = csvRows.join('\n');
            
            // Generate filename with timestamp
            const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            const campaignSuffix = selectedCampaign ? `_${selectedCampaign.replace(/\s+/g, '_')}` : '';
            const subcatSuffix = subcat ? `_${subcat.replace(/\s+/g, '_')}` : '';
            const filename = `SKU_Export_${categoryId}${subcatSuffix}${campaignSuffix}_${timestamp}.csv`;

            // Create download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function selectSKU(skuId, encodedName) {
            selectedSKU = skuId;
            if (encodedName) {
                try { selectedSKUName = decodeURIComponent(encodedName); } catch(_) { selectedSKUName = encodedName; }
            } else {
                // Fallback: lookup by id
                selectedSKUName = findSKUName(selectedCategory || 'electronics', skuId);
            }
            currentView = 'sku-detail';
            updateBreadcrumbs();
            showSKUDetail();
            updateURL('sku-detail', selectedCategory, selectedSKU);
        }

        // ---------- SKU data helpers ----------
        function buildSKURows(categoryId, subcat) {
            let data = generateSKUs(categoryId, subcat);
            // Filter by campaign if selected
            if (selectedCampaign) {
                data = data.filter(row => row.campaign === selectedCampaign);
            }
            const avgRevenue = data.reduce((s, r) => s + Number(r.revenue.replace(/[$,]/g,'')), 0) / Math.max(1,data.length);
            return data.map((row, idx) => {
                const campaignBadge = row.campaign ? `<span class="inline-flex items-center px-1.5 py-0 text-[10px] rounded ml-2" style="background: rgba(96,165,250,0.15); color:#60A5FA; border:1px solid rgba(96,165,250,0.25); font-weight: 500;">${row.campaign}</span>` : '';
                return `
                <tr class="hover:bg-gray-50 cursor-pointer" onclick="selectSKU('${row.id}','${encodeURIComponent(row.name)}')">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                            <input type="checkbox" class="sku-checkbox w-4 h-4 mr-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer" data-sku-id="${row.id}" onclick="event.stopPropagation();">
                                            <div>
                                <div class="text-sm font-medium text-gray-900 flex items-center mb-1.5">${row.name}${campaignBadge}</div>
                                <div class="text-xs text-gray-500">${row.categoryLabel} · ${relativeBadge(row.revenue, avgRevenue)}</div>
                                            </div>
                                        </div>
                                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${row.revenue}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${row.units}</td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">${row.missRate}%</span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">${row.confidenceLabel} (${row.confidence}%)</span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                        <button class="${row.actionClass} text-xs px-3 py-1">${row.action}</button>
                                    </td>
                                </tr>
            `;
            }).join('');
        }

        function generateSKUs(categoryId, subcat) {
            const catalogs = {
                electronics: ['iPhone 15 Pro','Galaxy S24','MacBook Air','iPad Pro','Sony WH-1000XM5','Pixel 8','Apple Watch','Surface Laptop','GoPro Hero','Kindle Oasis','Dell XPS 13','Nintendo Switch'],
                clothing: ['Nike Air Max','Adidas Ultraboost','Levi\'s 501 Jeans','North Face Jacket','Uniqlo Hoodie','Patagonia Tee','Lululemon Shorts','Zara Dress','Columbia Fleece','H&M Chinos','Birkenstock Sandals','New Balance 990'],
                toys: ['LEGO Set','Hot Wheels Pack','Barbie Dreamhouse','Nerf Blaster','Puzzle 1000pc','Uno Cards','Monopoly Classic','Play-Doh Kit','RC Car','Jenga','Rubik\'s Cube','Action Figure']
            };
            const manufacturers = {
                electronics: ['Apple','Samsung','Apple','Apple','Sony','Google','Apple','Microsoft','GoPro','Amazon','Dell','Nintendo'],
                clothing: ['Nike','Adidas','Levi Strauss & Co.','The North Face','Uniqlo','Patagonia','Lululemon','Inditex','Columbia Sportswear','H&M','Birkenstock','New Balance'],
                toys: ['LEGO Group','Mattel','Mattel','Hasbro','Ravensburger','Mattel','Hasbro','Hasbro','JJRC','Hasbro','Spin Master','Hasbro']
            };
            const campaigns = {
                electronics: ['Holiday 2025','Back to School','Holiday 2025',null,'Back to School',null,'Holiday 2025',null,null,'Back to School',null,'Holiday 2025'],
                clothing: ['Holiday 2025','Back to School',null,'Holiday 2025',null,null,'Summer Sale','Holiday 2025',null,null,'Summer Sale','Back to School'],
                toys: ['Holiday 2025','Summer Sale','Holiday 2025',null,'Back to School',null,'Holiday 2025','Summer Sale',null,null,null,'Holiday 2025']
            };
            const returnsRate = {
                electronics: [8.2, 14.5, 5.1, 6.8, 3.2, 18.7, 4.5, 9.3, 22.1, 7.6, 11.2, 5.9],
                clothing: [24.5, 19.2, 12.8, 8.3, 15.7, 6.2, 21.3, 28.4, 11.5, 16.8, 9.1, 13.4],
                toys: [6.7, 4.2, 11.8, 8.9, 3.5, 2.1, 7.4, 5.6, 16.3, 4.8, 3.2, 9.1]
            };
            const reviewScores = {
                electronics: [4.7, 4.2, 4.8, 4.6, 4.9, 3.8, 4.5, 4.3, 3.2, 4.1, 4.4, 4.7],
                clothing: [3.9, 4.5, 4.6, 4.7, 4.1, 4.8, 3.5, 3.1, 4.3, 4.0, 4.6, 4.4],
                toys: [4.8, 4.6, 4.3, 4.7, 4.9, 4.5, 4.2, 4.6, 3.4, 4.8, 4.7, 4.4]
            };
            const baseCat = categoryId === 'clothing' ? 'Clothing' : categoryId === 'toys' ? 'Toys & Games' : 'Electronics';
            const dots = ['bg-gray-400','bg-gray-500','bg-gray-600'];
            const actions = ['Reorder','Investigate','Markdown','Hold'];
            let names = catalogs[categoryId] || catalogs.electronics;
            let mfrs = manufacturers[categoryId] || manufacturers.electronics;
            let camps = campaigns[categoryId] || campaigns.electronics;
            let returns = returnsRate[categoryId] || returnsRate.electronics;
            let reviews = reviewScores[categoryId] || reviewScores.electronics;
            if (subcat && (subcategories[categoryId] || []).length) {
                const subList = subcategories[categoryId];
                const idx = Math.max(0, subList.indexOf(subcat));
                // Partition catalog deterministically so each subcategory shows a distinct subset
                names = names.filter((_, i) => i % subList.length === idx);
                mfrs = mfrs.filter((_, i) => i % subList.length === idx);
                camps = camps.filter((_, i) => i % subList.length === idx);
                returns = returns.filter((_, i) => i % subList.length === idx);
                reviews = reviews.filter((_, i) => i % subList.length === idx);
            }
            return names.slice(0, 12).map((name, i) => {
                const id = `${categoryId}_${i}`;
                const manufacturer = mfrs[i] || mfrs[0];
                const campaign = camps[i] || null;
                const returnRate = returns[i] || 5.0;
                const reviewScore = reviews[i] || 4.0;
                const units = 20 + (i * 7 % 180);
                const revenueVal = 2000 + (i * 137 % 7000);
                const revenue = `$${(revenueVal).toLocaleString()}`;
                const missRate = (2 + (i * 11 % 24) + (categoryId === 'clothing' ? 5 : 0)).toFixed(1);
                const conf = 45 + (i * 7 % 50);
                const confidence = Math.min(conf, 95);
                const confidenceLabel = confidence > 75 ? 'High' : confidence > 55 ? 'Medium' : 'Low';
                const action = actions[(i + (categoryId === 'toys' ? 1 : 0)) % actions.length];
                const actionClass = action === 'Reorder' || action === 'Markdown' ? 'btn btn-primary' : 'btn btn-secondary';
                return {
                    id,
                    name,
                    manufacturer,
                    campaign,
                    categoryLabel: baseCat,
                    units,
                    revenue,
                    missRate,
                    confidence,
                    confidenceLabel,
                    action,
                    actionClass,
                    dotClass: dots[i % dots.length],
                    returnRate,
                    reviewScore
                };
            });
        }

        function relativeBadge(revenueStr, avgRevenueStr) {
            const rev = Number(String(revenueStr).replace(/[$,]/g,''));
            const avg = Number(String(avgRevenueStr).replace(/[$,]/g,''));
            if (!avg) return '';
            const diff = Math.round(((rev - avg) / avg) * 100);
            const label = diff >= 0 ? `Above Avg ${diff}%` : `Below Avg ${Math.abs(diff)}%`;
            const color = diff >= 0 ? 'text-green-600' : 'text-red-600';
            return `<span class="${color}">${label}</span>`;
        }

        function findSKUName(categoryId, skuId) {
            const list = generateSKUs(categoryId);
            const found = list.find(x => x.id === skuId);
            return found ? found.name : skuId;
        }

        function showSKUDetail() {
            const mainContent = document.querySelector('main');
            const confPct = getSKUConfidence();
            const confClass = confPct >= 75 ? 'bg-green-50 text-green-700 border border-green-200' : (confPct >= 55 ? 'bg-amber-50 text-amber-700 border border-amber-200' : 'bg-red-50 text-red-700 border border-red-200');
            mainContent.innerHTML = `
                <div class="mb-8">
                    <h1 class="text-3xl font-semibold text-gray-900 mb-2">SKU Detail - ${selectedSKUName || selectedSKU}</h1>
                    <p class="text-gray-500">Individual SKU forecasting and backtesting</p>
                </div>

                <!-- Top row: Action (8) + Stock & Risk (4) -->
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 mb-8">
                    <div class="lg:col-span-8">
                        <div class="bg-white rounded-xl border border-gray-200 shadow-lg overflow-hidden card_highlight" id="sku-action-wrap" style="background-color:#28324E; border:2px solid rgba(96,165,250,0.60); box-shadow:0 0 0 1px rgba(96,165,250,0.45);">
                            <div id="sku-action-rail" class="h-full w-1.5 bg-blue-600 float-left"></div>
                            <div class="p-6 md:p-7" id="sku-action-card">
                                <!-- Populated by renderSKUAction() -->
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-4">
                        <div class="bg-white rounded-xl border border-gray-200 p-6 shadow-lg overflow-hidden" id="sku-stock-card">
                            <!-- Populated by renderStockRiskCard() -->
                        </div>
                    </div>
                </div>

                <div class="flex items-center mb-2">
                    <div class="inline-flex bg-gray-100 rounded-md p-1">
                        <button id="btn-ret-all" class="px-3 py-1 text-sm rounded-md bg-white shadow-sm">All</button>
                        <button id="btn-ret-walmart" class="px-3 py-1 text-sm rounded-md text-gray-600">Walmart</button>
                        <button id="btn-ret-amazon" class="px-3 py-1 text-sm rounded-md text-gray-600">Amazon</button>
                        <button id="btn-ret-target" class="px-3 py-1 text-sm rounded-md text-gray-600">Target</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white rounded-xl border border-gray-200 p-6 shadow-lg">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-lg font-semibold text-gray-900">Historical Performance</h3>
                            <div class="flex items-center gap-4">
                                <select id="comp-select" class="input w-auto text-sm">
                                    <option value="">Compare with…</option>
                                </select>
                                <button id="comp-add" class="btn btn-secondary text-sm px-4 py-2">Add</button>
                            </div>
                        </div>
                        <div id="comp-chips" class="flex flex-wrap gap-2 mb-1"></div>
                        <div class="flex items-center justify-between mb-0.5">
                            <div class="relative w-full h-3">
                                <span class="absolute text-xs text-gray-500" style="left:32%">Promo</span>
                                <span class="absolute text-xs text-gray-500" style="left:75%">Holiday</span>
                            </div>
                            <span class="inline-flex items-center px-2 py-0.5 text-xs font-medium rounded-md whitespace-nowrap ${confClass}">Confidence ${confPct}%</span>
                        </div>
                        <div class="h-60 bg-white rounded-lg">
                            <div id="sku-historical-chart" class="w-full h-full"></div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl border border-gray-200 p-6 shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">Forward Projection</h3>
                            <span class="inline-flex items-center px-2 py-0.5 text-xs font-medium rounded-md whitespace-nowrap ${confClass}">Confidence ${confPct}%</span>
                        </div>
                        <div class="h-64 bg-white rounded-lg">
                            <div id="sku-projection-chart" class="w-full h-full"></div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white rounded-xl border border-gray-200 p-6 shadow-lg" id="sku-margin-card"></div>
                    <div class="bg-white rounded-xl border border-gray-200 p-6 shadow-lg" id="sku-pricecost-card"></div>
                    <div class="bg-white rounded-xl border border-gray-200 p-6 shadow-lg" id="sku-diagnostics-card"></div>
                </div>

                <div class="bg-white rounded-xl border border-gray-200 p-6 shadow-lg mb-8" id="sku-retailer-optim"></div>

                <!-- Diagnostics moved into 3-card row above; removing duplicates here -->
            `;
            
            // Re-initialize icons
            lucide.createIcons();
            setTimeout(() => { renderSKUHistoricalChart(); renderSKUProjectionChart(); renderSKUAction(); renderSKUMarginCard(); renderSKUPriceCostCard(); renderSKUDiagnostics(); populateCompareDropdown(); renderCompareChips(); updateRetailerScopeButtons(); renderRetailerOptimizationCard(); }, 50);

            // Retailer scope buttons
            const scopeButtons = [
                { id: 'btn-ret-all', val: 'all' },
                { id: 'btn-ret-walmart', val: 'walmart' },
                { id: 'btn-ret-amazon', val: 'amazon' },
                { id: 'btn-ret-target', val: 'target' }
            ];
            scopeButtons.forEach(b => {
                const el = document.getElementById(b.id);
                if (el) el.onclick = () => { selectedRetailer = b.val; updateRetailerScopeButtons(); renderSKUHistoricalChart(); renderSKUProjectionChart(); renderRetailerOptimizationCard(); };
            });
        }

        function getSKUConfidence() {
            // Demo confidence; could vary by SKU later
            return 87;
        }
        
        function updateRetailerScopeButtons() {
            const map = {
                all: document.getElementById('btn-ret-all'),
                walmart: document.getElementById('btn-ret-walmart'),
                amazon: document.getElementById('btn-ret-amazon'),
                target: document.getElementById('btn-ret-target')
            };
            Object.keys(map).forEach(k => {
                const el = map[k]; if (!el) return;
                if (k === selectedRetailer) { el.classList.add('bg-white','shadow-sm'); el.classList.remove('text-gray-600'); }
                else { el.classList.remove('bg-white','shadow-sm'); el.classList.add('text-gray-600'); }
            });
        }

        function getRetailerFactor(r) {
            if (r === 'walmart') return 1.05;
            if (r === 'amazon') return 1.00;
            if (r === 'target') return 0.97;
            return 1.00;
        }

        function scaleSeries(series, factor) {
            return series.map(p => ({ month:p.month, actual:+(p.actual*factor).toFixed(2), baseline:+(p.baseline*factor).toFixed(2), model:+(p.model*factor).toFixed(2) }));
        }

        function renderRetailerOptimizationCard() {
            const el = document.getElementById('sku-retailer-optim');
            if (!el) return;
            const mix = [
                { name: 'Walmart', pct: 42 },
                { name: 'Amazon', pct: 38 },
                { name: 'Target', pct: 20 }
            ];
            const best = mix.reduce((a,b)=> (a.pct>b.pct?a:b));
            const colors = {
                Walmart: 'linear-gradient(90deg, rgba(96,165,250,0.9), rgba(59,130,246,0.7))',
                Amazon: '#475569',
                Target: '#334155'
            };
            const barHTML = `
                <div class="text-sm text-gray-500 mb-2">Projected share</div>
                <div class="flex h-2 w-full rounded overflow-hidden" style="background: rgba(148,163,184,0.15);">
                    ${mix.map(m=>`<div title="${m.name} ${m.pct}%" style=\"width:${m.pct}%; background:${colors[m.name]||'#475569'}\"></div>`).join('')}
                </div>
                <div class="flex justify-between text-xs text-gray-500 mt-2">
                    ${mix.map(m=>`<div class=\"flex items-center gap-2\"><span>${m.name}</span><span class=\"font-medium text-gray-300\">${m.pct}%</span></div>`).join('')}
                </div>`;

            el.innerHTML = `
                <h3 class="text-lg font-semibold text-gray-900 mb-3">Retailer Optimization</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-start">
                    <div>
                        <div class="text-sm text-gray-500 mb-1">Suggested focus</div>
                        <div class="flex items-center gap-2">
                            <div class="text-2xl font-semibold text-gray-900">${best.name}</div>
                            <span class="inline-flex items-center px-2 py-0.5 text-xs rounded-md" style="background: rgba(96,165,250,0.18); color:#60A5FA; border:1px solid rgba(96,165,250,0.35)">Focus</span>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">Highest projected share in next 3 months</div>
                    </div>
                    <div class="md:col-span-2">${barHTML}</div>
                </div>
            `;
        }
        function renderSKUPriceCostCard() {
            const el = document.getElementById('sku-pricecost-card');
            if (!el) return;
            const { perRetailer } = getSKUMarginData();
            const avg = (k) => Math.round(perRetailer.reduce((s, r) => s + r[k], 0) / perRetailer.length);
            const price = avg('price');
            const cost = avg('cost');
            const profit = price - cost;
            const profitPct = Math.round((profit / price) * 100);
            // Get manufacturer from selected SKU
            const skuList = generateSKUs(selectedCategory || 'electronics');
            const sku = skuList.find(s => s.id === selectedSKU);
            const manufacturer = sku ? sku.manufacturer : 'Unknown';
            el.innerHTML = `
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Price & Cost</h3>
                <div class="text-sm text-gray-500 mb-3">Manufacturer: <span class="font-medium text-gray-300">${manufacturer}</span></div>
                <div class="grid grid-cols-3 gap-4 mb-4">
                    <div>
                        <div class="text-sm text-gray-500">Avg Price</div>
                        <div class="text-xl font-semibold text-gray-900">$${price}</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-500">Avg Cost</div>
                        <div class="text-xl font-semibold text-gray-900">$${cost}</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-500">Gross Profit</div>
                        <div class="text-xl font-semibold text-gray-900">$${profit}</div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between text-xs text-gray-500 mb-1"><span>Cost</span><span>Price</span></div>
                    <div class="h-2 w-full bg-gray-100 rounded flex overflow-hidden">
                        <div class="bg-gray-300" style="width:${Math.max(0, Math.min(100, Math.round((cost/price)*100)))}%"></div>
                        <div class="bg-green-500" style="width:${Math.max(0, 100 - Math.round((cost/price)*100))}%"></div>
                    </div>
                    <div class="text-xs text-gray-600 mt-1">Profit ${profitPct}%</div>
                </div>
            `;
        }

        function renderSKUDiagnostics() {
            const el = document.getElementById('sku-diagnostics-card');
            if (!el) return;
            // Keep this minimal to avoid duplicating chart confidence
            const modelMAPE = 8.2;
            const baselineMAPE = 15.7;
            const improvement = Math.round(((baselineMAPE - modelMAPE) / baselineMAPE) * 1000) / 10; // 1 decimal
            el.innerHTML = `
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Model Diagnostics</h3>
                <div class="space-y-3">
                    <div class="flex justify-between"><span class="text-sm text-gray-500">Model MAPE</span><span class="font-semibold text-gray-900">${modelMAPE}%</span></div>
                    <div class="flex justify-between"><span class="text-sm text-gray-500">Baseline MAPE</span><span class="font-semibold text-gray-900">${baselineMAPE}%</span></div>
                    <div class="flex justify-between"><span class="text-sm text-gray-500">Improvement</span><span class="font-semibold text-green-600">+${improvement}%</span></div>
                </div>
            `;
        }

        function getSKUMarginData() {
            // Synthetic per‑retailer margin data and blended margin
            // Values chosen to be realistic for demo
            const perRetailer = [
                { retailer: 'Walmart', price: 999, cost: 690 },
                { retailer: 'Amazon', price: 999, cost: 640 },
                { retailer: 'Target', price: 979, cost: 650 }
            ].map(r => ({ ...r, marginPct: Math.round(((r.price - r.cost) / r.price) * 100) }));
            const blended = Math.round(perRetailer.reduce((s, r) => s + r.marginPct, 0) / perRetailer.length);
            return { blended, perRetailer };
        }

        function renderSKUMarginCard() {
            const el = document.getElementById('sku-margin-card');
            if (!el) return;
            const { blended, perRetailer } = getSKUMarginData();
            const rows = perRetailer.map(r => `
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">${r.retailer}</span>
                    <span class="text-gray-900 font-medium">${r.marginPct}%</span>
                </div>
            `).join('');
            el.innerHTML = `
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Margin & Profitability</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="md:col-span-1">
                        <div class="text-sm text-gray-500 mb-1">Blended Margin</div>
                        <div class="text-2xl font-semibold text-gray-900">${blended}%</div>
                        <div class="mt-3">
                            <div class="h-2 w-full bg-gray-100 rounded">
                                <div class="h-2 bg-blue-600 rounded" style="width:${blended}%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="md:col-span-2">
                        <div class="text-sm text-gray-500 mb-2">Per‑retailer margin</div>
                        <div class="space-y-2">${rows}</div>
                    </div>
                </div>
            `;
        }

        

        function updateBreadcrumbs() {
            const breadcrumbElement = document.getElementById('breadcrumbs');
            if (!breadcrumbElement) return;
            if (currentView === 'portfolio') {
                breadcrumbElement.innerHTML = `
                    <span class="cursor-pointer text-blue-600 hover:underline" onclick="goToPortfolio()">Overview</span>
                `;
            } else if (currentView === 'category') {
                breadcrumbElement.innerHTML = `
                    <span class="cursor-pointer text-blue-600 hover:underline" onclick="goToPortfolio()">Overview</span>
                    <span>/</span>
                    <span class="cursor-pointer text-blue-600 hover:underline" onclick="goToCategories()">Categories</span>
                `;
            } else if (currentView === 'sku') {
                breadcrumbElement.innerHTML = `
                    <span class="cursor-pointer text-blue-600 hover:underline" onclick="goToPortfolio()">Overview</span>
                    <span>/</span>
                    <span class="cursor-pointer text-blue-600 hover:underline" onclick="goToCategories()">Categories</span>
                    <span>/</span>
                    <span class="cursor-pointer text-blue-600 hover:underline" onclick="goToSKUs()">SKUs</span>
                `;
            } else if (currentView === 'sku-detail') {
                breadcrumbElement.innerHTML = `
                    <span class="cursor-pointer text-blue-600 hover:underline" onclick="goToPortfolio()">Overview</span>
                    <span>/</span>
                    <span class="cursor-pointer text-blue-600 hover:underline" onclick="goToCategories()">Categories</span>
                    <span>/</span>
                    <span class="cursor-pointer text-blue-600 hover:underline" onclick="goToSKUs()">SKUs</span>
                    <span>/</span>
                    <span class="cursor-pointer text-blue-600 hover:underline" onclick="goToSKUs()">SKU Detail</span>
                `;
            }
        }

        // Navigation functions
        function goToHomepage() {
            currentView = 'portfolio';
            selectedCategory = null;
            selectedSKU = null;
            showPortfolioView();
            // Clean URL to base path on homepage
            history.replaceState({ view: 'portfolio' }, '', location.pathname);
            setTimeout(renderPortfolioChart, 50);
        }

        function goToPortfolio() {
            currentView = 'portfolio';
            selectedCategory = null;
            selectedSKU = null;
            showPortfolioView();
            updateURL('portfolio', null, null);
            setTimeout(renderPortfolioChart, 50);
        }

        function goToCategories() {
            currentView = 'category';
            selectedSKU = null;
            updateBreadcrumbs();
            showCategoryView();
            updateURL('category', selectedCategory, null);
        }

        function goToSKUs() {
            currentView = 'sku';
            updateBreadcrumbs();
            showSKUView();
            updateURL('sku', selectedCategory, null);
        }

        function showPortfolioView() {
            const mainContent = document.querySelector('main');
            mainContent.innerHTML = `
                <!-- Hero Section -->
                

                <!-- Hero KPIs -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="kpi-card card-hover rounded-xl p-6 shadow-lg cursor-pointer" onclick="showCategories()">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-500 mb-1">Total Revenue</p>
                                <p class="text-2xl font-semibold text-gray-900">$2.4M</p>
                                <p class="text-sm text-gray-500 mt-1">Last 24 months</p>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-green-600">+12.3%</span>
                            </div>
                        </div>
                    </div>

                    <div class="kpi-card card-hover rounded-xl p-6 shadow-lg cursor-pointer" onclick="showCategories()">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-500 mb-1">Forecast Revenue</p>
                                <p class="text-2xl font-semibold text-gray-900">$2.7M</p>
                                <p class="text-sm text-gray-500 mt-1">Next 3 months</p>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-green-600">+12.3%</span>
                            </div>
                        </div>
                    </div>

                    <div class="kpi-card card-hover rounded-xl p-6 shadow-lg cursor-pointer" onclick="showCategories()">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-500 mb-1">Miss Rate</p>
                                <p class="text-2xl font-semibold text-gray-900">8.2%</p>
                                <p class="text-sm text-gray-500 mt-1">Model vs Baseline</p>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-red-600">-5.2%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Role-specific KPIs -->
                <div id="role-specific-kpis" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <!-- Ops KPIs -->
                <div class="bg-white rounded-lg border border-gray-200 p-6 shadow-sm" style="border-color: rgba(239,68,68,0.35) !important; border-width: 2px !important; border-style: solid !important;">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-500 mb-1">Inventory Risk</p>
                                <p class="text-2xl font-semibold text-gray-900">Medium</p>
                                <p class="text-sm text-gray-500 mt-1">3 categories at risk</p>
                            </div>
                            <div class="text-blue-600">
                                <i data-lucide="package" class="w-6 h-6"></i>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg border border-gray-200 p-6 shadow-sm" style="border-color: rgba(16,185,129,0.35) !important; border-width: 2px !important; border-style: solid !important;">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-500 mb-1">Stockout Risk</p>
                                <p class="text-2xl font-semibold text-gray-900">Low</p>
                                <p class="text-sm text-gray-500 mt-1">2 SKUs flagged</p>
                            </div>
                            <div class="text-blue-600">
                                <i data-lucide="alert-triangle" class="w-6 h-6"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Chart -->
                <div class="card p-6 mb-8">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Revenue Forecast vs Actuals</h3>
                        <div class="flex items-center space-x-4">
                            <div class="flex items-center space-x-2">
                                <div class="w-3 h-3 bg-blue-600 rounded-full"></div>
                                <span class="text-sm text-gray-500">Actual</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="w-3 h-3 bg-gray-400 rounded-full"></div>
                                <span class="text-sm text-gray-500">Baseline</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                                <span class="text-sm text-gray-500">Model Forecast</span>
                            </div>
                        </div>
                    </div>
                    <div class="h-80 bg-white rounded-lg">
                        <div id="portfolio-chart" class="w-full h-full"></div>
                    </div>
                </div>

                <!-- Insights + Nav Row -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8">
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Top Insights</h3>
                        <div class="space-y-3">
                            <div class="flex items-start space-x-3">
                                <div class="w-2 h-2 bg-green-600 rounded-full mt-2"></div>
                                <div>
                                    <p class="text-sm font-medium text-gray-900">Electronics category up 22%</p>
                                    <p class="text-xs text-gray-500">Supply down. Reorder now.</p>
                                </div>
                            </div>
                            <div class="flex items-start space-x-3">
                                <div class="w-2 h-2 bg-yellow-500 rounded-full mt-2"></div>
                                <div>
                                    <p class="text-sm font-medium text-gray-900">Clothing confidence low</p>
                                    <p class="text-xs text-gray-500">Sparse history. Investigate.</p>
                                </div>
                            </div>
                            <div class="flex items-start space-x-3">
                                <div class="w-2 h-2 bg-red-600 rounded-full mt-2"></div>
                                <div>
                                    <p class="text-sm font-medium text-gray-900">Toys & Games forecast down 15%</p>
                                    <p class="text-xs text-gray-500">Weeks of supply >8. Markdown recommended.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- View Categories (middle) -->
                    <div class="card p-6">
                        <div class="flex items-center space-x-3 mb-2">
                            <i data-lucide="bar-chart-3" class="w-5 h-5 text-blue-600"></i>
                            <h4 class="font-semibold text-gray-900">View Categories</h4>
                        </div>
                        <ul class="text-sm space-y-2">
                            <li><a href="#" onclick="chooseCategory('electronics'); return false;" class="text-blue-600 hover:underline">Electronics</a></li>
                            <li><a href="#" onclick="chooseCategory('clothing'); return false;" class="text-blue-600 hover:underline">Clothing</a></li>
                            <li><a href="#" onclick="chooseCategory('toys'); return false;" class="text-blue-600 hover:underline">Toys & Games</a></li>
                        </ul>
                    </div>
                    <!-- View Misses (right) -->
                    <div class="card p-6">
                        <div class="flex items-center space-x-3 mb-2">
                            <i data-lucide="alert-triangle" class="w-5 h-5 text-yellow-500"></i>
                            <h4 class="font-semibold text-gray-900">View Misses</h4>
                        </div>
                        <ul class="text-sm space-y-2">
                            <li><span>High miss:</span> <span class="text-blue-600 hover:underline cursor-pointer">Electronics − Baseline MAPE 24%</span></li>
                            <li><span>Low confidence:</span> <span class="text-blue-600 hover:underline cursor-pointer">Clothing − Investigate sparse history</span></li>
                            <li><span>Overstock:</span> <span class="text-blue-600 hover:underline cursor-pointer">Toys & Games − WOS > 8, apply markdown</span></li>
                        </ul>
                    </div>
                </div>

                
            `;
            
            updateBreadcrumbs();
            updateRoleContent();
            lucide.createIcons();
            // Ensure portfolio chart renders after DOM injection when navigating home
            setTimeout(renderPortfolioChart, 50);
        }

        // Simple contextual tour using backdrop + cloned highlighted element
        let tourStep = 0;
        let tourBackdrop = null;
        let tourTooltip = null;
        let tourHighlight = null;
        
        function startTour() {
            tourStep = 0;
            showTourStep();
        }

        function showTourStep() {
            // Clean up previous step and any navigation prompts
            cleanupTour();
            const existingPrompt = document.getElementById('tour-nav-prompt');
            if (existingPrompt) document.body.removeChild(existingPrompt);
            
            const steps = [
                // Portfolio page (2 steps)
                { title: 'Portfolio KPIs', message: 'Monitor key metrics at a glance: Total Revenue, Forecast Revenue, and Miss Rate. You can navigate and drill down into categories from here by clicking on any card.', selector: '.kpi-card:first-child', page: 'portfolio' },
                { title: 'Revenue Forecast Chart', message: 'Compare Model Forecast vs Baseline vs Actuals. The chart shows historical performance and forward projections through 2024-12.', selector: '.recharts-wrapper', page: 'portfolio' },
                
                // Categories page (3 steps - auto-navigate on Next)
                { title: 'Category Cards', message: 'Each category shows revenue, forecast confidence, and actionable recommendations. Click "View SKUs" to drill into individual products.', selector: '.card:first-child', page: 'categories', autoNavigate: () => showCategories() },
                { title: 'Category Performance Chart', message: 'Compare category performance over time. Use the Category/Portfolio toggle in the upper right to switch views and analyze different data perspectives.', selector: '.recharts-wrapper', page: 'categories' },
                { title: 'View SKUs', message: 'Ready to dive deeper? Click "View SKUs" on any category card to drill down into individual SKU performance and take specific actions.', selector: '.card:first-child', page: 'categories' },
                
                // SKU List page (1 step - auto-navigate on Next)
                { title: 'SKU Performance Table', message: 'This table shows individual SKU performance with key metrics: Revenue, Units, Miss Rate, Confidence, and recommended Actions. Each row represents a product you can analyze and optimize.', selector: 'table', page: 'sku', autoNavigate: () => { selectedCategory = 'electronics'; selectedSubcategory = null; currentView = 'sku'; updateBreadcrumbs(); showSKUView(); updateURL('sku', selectedCategory, null); } },
                
                // SKU Detail page (1 step - auto-navigate on Next)
                { title: 'Compare with Competitors', message: 'Use the "Compare with..." dropdown to overlay competitor SKU performance on the Historical Performance chart. This helps you understand how your products stack up against alternatives and identify opportunities.', selector: 'select', page: 'sku-detail', autoNavigate: () => { selectedCategory = 'electronics'; selectedSKU = 'electronics_0'; selectedSKUName = 'Premium Bluetooth Headphones'; currentView = 'sku-detail'; updateBreadcrumbs(); showSKUDetail(); updateURL('sku-detail', selectedCategory, selectedSKU); } },
                
                // Final completion step
                { title: 'Tour Complete!', message: 'You\'ve explored the key features of Forecasting 2.0! You can now navigate freely, analyze SKU performance, compare competitors, and take action on recommendations. Click "Finish" to close this tour.', selector: null, page: 'sku-detail' }
            ];
            
            if (tourStep >= steps.length) { 
                cleanupTour();
                return; 
            }
            
            const step = steps[tourStep];
            
            // If step requires navigation and we're not on the right page, auto-navigate
            const pageMatches = (step.page === 'portfolio' && currentView === 'portfolio') ||
                                (step.page === 'categories' && currentView === 'category') ||
                                (step.page === 'sku' && currentView === 'sku') ||
                                (step.page === 'sku-detail' && currentView === 'sku-detail');
            
            if (!pageMatches && step.autoNavigate) {
                // Auto-navigate to the required page
                step.autoNavigate();
                // Wait for DOM to update, then show the step
                setTimeout(() => showTourStep(), 300);
                return;
            }
            
            // Create much darker backdrop (95% opacity)
            tourBackdrop = document.createElement('div');
            tourBackdrop.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.95);z-index:99998;transition:opacity 0.3s;';
            document.body.appendChild(tourBackdrop);
            
            // Create tooltip with bright amber/yellow border for high visibility
            tourTooltip = document.createElement('div');
            tourTooltip.style.cssText = 'position:fixed;z-index:100000;background:#1e293b;border:3px solid #FBBF24;border-radius:12px;padding:20px 24px;max-width:420px;box-shadow:0 20px 25px -5px rgba(0,0,0,0.8),0 0 0 1px rgba(251,191,36,0.3);';
            
            // Position tooltip and highlight
            if (step.selector) {
                const target = document.querySelector(step.selector);
                if (target) {
                    const rect = target.getBoundingClientRect();
                    
                    // CRITICAL: Boost target element z-index so it appears ABOVE the dark backdrop
                    const originalPosition = target.style.position;
                    const originalZIndex = target.style.zIndex;
                    const originalOverflow = target.style.overflow;
                    target.style.position = 'relative';
                    target.style.zIndex = '99999';
                    target.style.overflow = 'visible'; // Ensure content isn't clipped
                    
                    // Also elevate parent containers if needed
                    let parent = target.parentElement;
                    const elevatedParents = [];
                    while (parent && parent !== document.body) {
                        if (window.getComputedStyle(parent).overflow !== 'visible') {
                            elevatedParents.push({
                                el: parent,
                                origOverflow: parent.style.overflow,
                                origPosition: parent.style.position,
                                origZIndex: parent.style.zIndex
                            });
                            parent.style.overflow = 'visible';
                            parent.style.position = 'relative';
                            parent.style.zIndex = '99999';
                        }
                        parent = parent.parentElement;
                    }
                    
                    // Create highlight border box with bright amber for high visibility
                    tourHighlight = document.createElement('div');
                    tourHighlight.style.cssText = `position:fixed;top:${rect.top-8}px;left:${rect.left-8}px;width:${rect.width+16}px;height:${rect.height+16}px;border:4px solid #FBBF24;border-radius:12px;box-shadow:0 0 0 4px rgba(251,191,36,0.3),0 0 40px rgba(251,191,36,0.6);z-index:100000;pointer-events:none;`;
                    document.body.appendChild(tourHighlight);
                    
                    // Store original styles for cleanup
                    tourHighlight._target = target;
                    tourHighlight._originalPosition = originalPosition;
                    tourHighlight._originalZIndex = originalZIndex;
                    tourHighlight._originalOverflow = originalOverflow;
                    tourHighlight._elevatedParents = elevatedParents;
                    
                    // Smart positioning to avoid cutoff
                    const tooltipHeight = 280; // Estimated tooltip height (increased for safety)
                    const spaceBelow = window.innerHeight - rect.bottom;
                    const spaceAbove = rect.top;
                    
                    // Check if element is very large (like the chart or table)
                    const elementHeight = rect.height;
                    const isLargeElement = elementHeight > 400;
                    
                    // For large elements or when not enough space above/below, center it
                    if (isLargeElement || (spaceAbove < 320 && spaceBelow < 320)) {
                        // Center vertically
                        tourTooltip.style.top = '50%';
                        tourTooltip.style.left = '50%';
                        tourTooltip.style.bottom = 'auto';
                        tourTooltip.style.transform = 'translate(-50%, -50%)';
                    } else if (spaceBelow < tooltipHeight + 40 && spaceAbove > tooltipHeight + 40) {
                        // Position above
                        tourTooltip.style.bottom = `${window.innerHeight - rect.top + 24}px`;
                        tourTooltip.style.top = 'auto';
                        tourTooltip.style.left = `${rect.left + rect.width/2}px`;
                        tourTooltip.style.transform = 'translateX(-50%)';
                    } else {
                        // Position below (default)
                        tourTooltip.style.top = `${rect.bottom + 24}px`;
                        tourTooltip.style.left = `${rect.left + rect.width/2}px`;
                        tourTooltip.style.bottom = 'auto';
                        tourTooltip.style.transform = 'translateX(-50%)';
                    }
                }
            } else {
                // Center for non-highlighted steps
                tourTooltip.style.top = '50%';
                tourTooltip.style.left = '50%';
                tourTooltip.style.transform = 'translate(-50%, -50%)';
            }
            
            tourTooltip.innerHTML = `
                <div style="margin-bottom:6px;color:#FBBF24;font-size:11px;font-weight:700;letter-spacing:0.8px;">STEP ${tourStep + 1} OF ${steps.length}</div>
                <h3 style="color:#f1f5f9;font-size:19px;font-weight:600;margin-bottom:12px;line-height:1.3;">${step.title}</h3>
                <p style="color:#cbd5e1;font-size:14px;line-height:1.6;margin-bottom:20px;">${step.message}</p>
                <div style="display:flex;gap:12px;justify-content:flex-end;align-items:center;">
                    <button id="tour-skip" style="background:transparent;padding:8px 14px;font-size:13px;border:none;cursor:pointer;transition:all 0.2s;">Skip Tour</button>
                    <button id="tour-next" style="background:#FBBF24;padding:10px 20px;border-radius:8px;font-size:14px;border:none;cursor:pointer;font-weight:700;transition:background 0.2s;">${tourStep === steps.length - 1 ? 'Finish ✓' : 'Next →'}</button>
                </div>
            `;
            
            document.body.appendChild(tourTooltip);
            
            // Force button colors after adding to DOM
            const nextBtn = document.getElementById('tour-next');
            const skipBtn = document.getElementById('tour-skip');
            
            nextBtn.style.color = '#000000';
            skipBtn.style.color = '#1f2937';
            skipBtn.style.textShadow = '0 0 8px rgba(255,255,255,0.8)';
            
            nextBtn.onclick = () => { 
                tourStep++;
                showTourStep();
            };
            nextBtn.onmouseover = () => { nextBtn.style.background = '#F59E0B'; };
            nextBtn.onmouseout = () => { nextBtn.style.background = '#FBBF24'; };
            
            skipBtn.onclick = () => {
                cleanupTour();
            };
            skipBtn.onmouseover = () => { 
                skipBtn.style.color = '#000000'; 
                skipBtn.style.textShadow = '0 0 12px rgba(255,255,255,1)';
            };
            skipBtn.onmouseout = () => { 
                skipBtn.style.color = '#1f2937'; 
                skipBtn.style.textShadow = '0 0 8px rgba(255,255,255,0.8)';
            };
            tourBackdrop.onclick = () => {
                cleanupTour();
            };
        }

        function cleanupTour() {
            if (tourBackdrop) {
                document.body.removeChild(tourBackdrop);
                tourBackdrop = null;
            }
            if (tourTooltip) {
                document.body.removeChild(tourTooltip);
                tourTooltip = null;
            }
            if (tourHighlight) {
                // Restore original element styles
                if (tourHighlight._target) {
                    tourHighlight._target.style.position = tourHighlight._originalPosition || '';
                    tourHighlight._target.style.zIndex = tourHighlight._originalZIndex || '';
                    tourHighlight._target.style.overflow = tourHighlight._originalOverflow || '';
                }
                // Restore parent element styles
                if (tourHighlight._elevatedParents) {
                    tourHighlight._elevatedParents.forEach(p => {
                        p.el.style.overflow = p.origOverflow || '';
                        p.el.style.position = p.origPosition || '';
                        p.el.style.zIndex = p.origZIndex || '';
                    });
                }
                document.body.removeChild(tourHighlight);
                tourHighlight = null;
            }
        }

        function closeTour() {
            tourStep = 0;
            cleanupTour();
        }
    </script>
</body>
</html>


